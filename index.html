<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="manifest" href="/manifest.json"><meta name="google-site-verification" content="Ke_HLBE1VTaPAM92Uvmu83gGuH28rv4bw7lfrfr2Fc8"><meta name="msvalidate.01" content="E071B510B0369A55948886E7534E0B0C"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"notes.guoliangwu.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="Idea, Action"><meta property="og:type" content="blog"><meta property="og:title" content="Liangwu&#39;s Notes"><meta property="og:url" content="https://notes.guoliangwu.com/index.html"><meta property="og:site_name" content="Liangwu&#39;s Notes"><meta property="og:description" content="Idea, Action"><meta property="og:locale" content="en_US"><meta property="article:author" content="Liangwu"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://notes.guoliangwu.com/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Liangwu's Notes</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Liangwu's Notes</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Just note anything</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Liangwu" src="https://avatars.githubusercontent.com/u/1228007?v=4"><p class="site-author-name" itemprop="name">Liangwu</p><div class="site-description" itemprop="description">Idea, Action</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/glw119" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://weibo.com/glw119" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a> </span><span class="links-of-author-item"><a href="https://twitter.com/glw119" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a></span></div></div></div></div></aside></div><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2024/01/29/home-network-configuration/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/01/29/home-network-configuration/" class="post-title-link" itemprop="url">家庭网络配置</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2024-01-29 12:32:12" itemprop="dateCreated datePublished" datetime="2024-01-29T12:32:12+08:00">2024-01-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>19年的时候搞了块J3455的板子自己拼了个NAS，可能机箱空间太小，硬盘数据线有时接触不佳，老掉盘。搞了2个2T,1个3T的SATA硬盘，当时图便宜都是SMR的盘，硬盘数据老真的是老慢慢，现在准备是用来搞冷备使用了。系统盘当时用的一个Thinkpad T400淘汰下来2.5寸的机械硬盘，老盘时常出问题，一出问题就只能把机箱搬到电视机前（家里没有HDMI显示器），然后再调试。搞过几次吧，很烦，于是搞了个HPE Microserver Gen8，主要是有iLO，解决显示器的问题。然后后面又搞了一些二手的东西，把家里的网络终于搞得可用了。</p><h2 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h2><p>GPON: <code>Nokia G-010S-A</code>，原来用的是运营商光猫桥接，然后有个<code>Buffalo WZR-HP-AG300H</code>刷了OpenWrt来拨号。后来买了个弱三层的交换机，就全部网络设备动了动。</p><p>主路由：<code>EdgeRouter X-SFP</code>，当时在小黄鱼蹲守的时候，主要看中的是这个和<code>Mirotik hEX S</code>，两个价格差不多，但前者存储比后者大，所以就入了X-SFP。入手后发现还是X-SFP比较适合我吧，系统基于Debian，配置相对ROS也简单。但确实ROS要配置更丰富一些。</p><p><em>核心</em>交换机：<code>Huarong S5735S-L8T4S-QA2</code>，当时某项目现场用到了这个型号，PDD入了一个，感觉应该是弱三层里非常非常便宜的了。</p><p><em>接入</em>交换机：<code>Linksys SLM2008</code>，简单网管交换机，最早为了测试链路聚合，二手入的。</p><p>无线<em>AP</em>：<code>Huawei AX6</code>，刚开始用的是<code>Tenda AC6</code>。两个都是纯AP模式，后面新买的效果真的是秒杀。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>以前用的是OpenWrt通过MAC配合防火墙来实现设备是否可以上网，解决未经许可连接WIFI的人蹭网，主要是常常有人用Android的什么万能钥匙，<a href="/2019/04/05/openwrt-restricting-internet-access-based-on-mac-address/">具体设置</a>。</p><p>现在用弱三层交换机当核心，实现DHCP Server，ACL控制，路由器与交换机通过OSPF动态路由，这样交换机及路由器功能分开，坏一个，其他能正常工作。不同网段通过ACL进行限速。</p><p>然后用GPON可以省掉光猫。用AX6无线路由器当AP，再配合交换机的MAC-VLAN功能，实现无线设备的网络隔离。</p><p>具体现有的大致网络示意图如下。</p><p><img data-src="https://onedrive.live.com/embed?resid=144CD4C035C1BE4B!1315243&authkey=!AG0aEsKgwprzzUs&width=801&height=864" alt="networking"></p><h3 id="GPON"><a href="#GPON" class="headerlink" title="GPON"></a>GPON</h3><p>最初想直接把GPON插在交换机上使用，发现可以识别，但无法使用，后面才买的X-SFP路由器。但GPON最开始的时候LAN IP是<code>192.168.1.10</code>，和现有的网络冲突，记得好像是用<code>fwsetenv</code>的命令改了IP地址，只修改配置文件不行，稍微研究了下，应该是配置文件写到变量里面去了，启动的时候读取mtd分区来设置环境变量，所以单纯修改配置文件无效。</p><h3 id="主路由"><a href="#主路由" class="headerlink" title="主路由"></a>主路由</h3><p>路由器用的是X-SFP，基本满足了我的需求，但是IPv6这块有点小问题，好像无法用DHCPv6 Server来分配从ISP获得的IPv6 PD进行网络划分，但Mikrotik可以实现。OSPF动态路由，主网10.0.0.0&#x2F;24（路由器LAN），子网192.168.100.0&#x2F;24（GPON LAN）。</p><p>现在主路由的功能主要是：</p><ol><li>PPPoE拨号</li><li>FRP内网穿透（IPv4 SSH）</li><li>Wireguard，外网可连接路由器</li><li>脚本实现IPv6 DDNS，DigitalOcean可以通过curl来更新DNS记录，方便用IPv6的时候进行连接SSH控制内网。</li></ol><script src="//gist.github.com/888e318fd1f49ec4063fc016e67c7079.js?file=updateEdgeosDNS.sh"></script><ol start="5"><li>DNS查询转至内网<code>Pihole</code>，解决部分流氓软件或广告，以及实现内外网同一域名访问服务。同时运行一个小脚本，当内网<code>Pihole</code>无法正常提供服务器，放行外网DNS查询。</li></ol><script src="//gist.github.com/888e318fd1f49ec4063fc016e67c7079.js?file=pihole-check.sh"></script><p>其他上<a target="_blank" rel="noopener" href="https://github.com/psitem/edgerouter-backup">Github</a>上找了一个自动备份的脚本，原本是可以在<code>commit</code>的时候自动进行备份，后面发现在频繁，于是改动每天自动备份。</p><p>其中各接口用途：</p><ul><li>Eth0: 之前用于接光猫桥接进行PPPoE拨号的，后空着，后续如果ISP禁了GPON的话，可以直接连光猫使用。</li><li>Eth1、Eth2: Switch0（10.0.0.1&#x2F;24），VIF 1000（IPv6），接内网。</li><li>Eth3: 192.168.200.1，PoE 24v供电给Mikrotik 750Gr3，开启DHCP Server，主要是测试Ros使用，不测试的时候PoE取消。</li><li>Eth4: VIF 8（192.168.8.x），连接交换机管理VLAN，可通过路由器直接管理交换机。</li><li>Eth5: 192.168.100.1，PPPoE拨号。</li></ul><p><a target="_blank" rel="noopener" href="https://gist.github.com/glw119/888e318fd1f49ec4063fc016e67c7079#file-er-x-sfp-config">路由器具体配置</a>，其中部分就是防火墙部分需要开启对应的规则，LOCAL、IN等端口。</p><h4 id="路由器IPv6设置"><a href="#路由器IPv6设置" class="headerlink" title="路由器IPv6设置"></a>路由器IPv6设置</h4><p>最开始向导设置的时候就启用IPv6，这样系统会自动创建IPv6的防火墙规则，省不少事。IPv6我主要是用来外网直接访问内网服务和SSH，以及PT下载。AKA：之前是可以直接访问443端口的，后来封掉，只改用其他端口了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">firewall &#123;</span><br><span class="line">  options &#123;</span><br><span class="line">    mss-clamp &#123;</span><br><span class="line">      interface-type pppoe</span><br><span class="line">      mss 1452</span><br><span class="line">    &#125;</span><br><span class="line">    mss-clamp6 &#123;</span><br><span class="line">      interface-type pppoe</span><br><span class="line">      mss 1432 #解决IPv6上网慢的问题</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">interfaces &#123;</span><br><span class="line">  ethernet eth5 &#123;</span><br><span class="line">    address 192.168.100.1/24</span><br><span class="line">    description &quot;Internet SFP&quot;</span><br><span class="line">    pppoe 1 &#123;</span><br><span class="line">      default-route auto</span><br><span class="line">      dhcpv6-pd &#123;</span><br><span class="line">        no-dns</span><br><span class="line">        pd 1 &#123;</span><br><span class="line">          interface switch0.1000 &#123;</span><br><span class="line">            host-address ::1</span><br><span class="line">            no-dns</span><br><span class="line">            prefix-id :1</span><br><span class="line">            service slaac</span><br><span class="line">          &#125;</span><br><span class="line">          prefix-length /60</span><br><span class="line">        &#125;</span><br><span class="line">        rapid-commit enable</span><br><span class="line">      &#125;</span><br><span class="line">      ipv6 &#123;</span><br><span class="line">        address &#123;</span><br><span class="line">          autoconf</span><br><span class="line">        &#125;</span><br><span class="line">        dup-addr-detect-transmits 1</span><br><span class="line">        enable &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  switch switch0 &#123;</span><br><span class="line">    vif 1000 &#123;</span><br><span class="line">      description IPv6_HOME_LAN</span><br><span class="line">      ipv6 &#123;</span><br><span class="line">        router-advert &#123;</span><br><span class="line">          default-lifetime 1800</span><br><span class="line">          max-interval 600</span><br><span class="line">          min-interval 60</span><br><span class="line">          prefix ::/64 &#123;</span><br><span class="line">            autonomous-flag true</span><br><span class="line">            on-link-flag true</span><br><span class="line">            preferred-lifetime 86400</span><br><span class="line">            valid-lifetime 86400</span><br><span class="line">          &#125;</span><br><span class="line">          reachable-time 0</span><br><span class="line">          retrans-timer 0</span><br><span class="line">          send-advert true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  wireguard wg0 &#123;</span><br><span class="line">    address 10.8.2.x/32</span><br><span class="line">    description Wireguard</span><br><span class="line">    mtu 1420</span><br><span class="line">    peer xxx &#123;</span><br><span class="line">      allowed-ips 10.8.2.0/24</span><br><span class="line">      endpoint xxxx:52550</span><br><span class="line">      persistent-keepalive 60</span><br><span class="line">    &#125;</span><br><span class="line">    private-key ****************</span><br><span class="line">    route-allowed-ips true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">service &#123;</span><br><span class="line">  # 转发DNS请求至pihole</span><br><span class="line">  nat &#123;</span><br><span class="line">    rule 10 &#123;</span><br><span class="line">      description DNS</span><br><span class="line">      destination &#123;</span><br><span class="line">        address !192.168.1.199</span><br><span class="line">        port 53,5353,5354,853</span><br><span class="line">      &#125;</span><br><span class="line">      inbound-interface switch0</span><br><span class="line">      inside-address &#123;</span><br><span class="line">        address 192.168.1.199</span><br><span class="line">        port 53</span><br><span class="line">      &#125;</span><br><span class="line">      protocol tcp_udp</span><br><span class="line">      source &#123;</span><br><span class="line">        address !192.168.1.199</span><br><span class="line">      &#125;</span><br><span class="line">      type destination</span><br><span class="line">    &#125;</span><br><span class="line">    rule 5002 &#123;</span><br><span class="line">      description &quot;Maqquerade for DNS&quot;</span><br><span class="line">      destination &#123;</span><br><span class="line">        address 192.168.1.199</span><br><span class="line">        port 53</span><br><span class="line">      &#125;</span><br><span class="line">      outbound-interface switch0</span><br><span class="line">      protocol tcp_udp</span><br><span class="line">      source &#123;</span><br><span class="line">        address 192.168.0.0/16</span><br><span class="line">      &#125;</span><br><span class="line">      type masquerade</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="核心交换机"><a href="#核心交换机" class="headerlink" title="核心交换机"></a><em>核心</em>交换机</h2><p>当时想搞个三层交换机的原因就是想家里用VLAN进行网络隔离，并对不同网段进行上网限制，但内网访问速度不进行限。最早的时候用<code>X-SFP</code>当单臂路由进行VLAN隔离的，网间流量需要经过路由器，且路由器firewall规则多了之后会影响速度，最后买了个弱三层交换机。</p><p>有线部分的网段划分比较简单，然后AX6不支持WIFI VLAN隔离，最后查文档的时候想到VLAN划分还有MAC划分，然后想着就WIFI过来靠MAC进行VLAN划分。</p><p>VLAN划分如下：</p><ul><li>8: 管理VLAN</li><li>100: 用于上行链路，连路由器</li><li>200: 服务器及需要大带宽的设备，不限速，其他网段无法访问此网段，除NAS，Pihole</li><li>210: 一般设备接入，默认WIFI接入VLAN，下行限100，上行限20</li><li>220: 用于IoT，摄像头、天猫精灵、火火兔等，下行限10，上行限10</li><li>230: 用于不让连外网的设备，电视机、无线路由器AX6、空调、天猫精灵（不让小孩听的时候）等</li><li>1000: 用于IPv6接入</li></ul><p>每VLAN配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">vlan 8</span><br><span class="line"> description lan for mgmt</span><br><span class="line"> name MGMT_LAN</span><br><span class="line"> management-vlan</span><br><span class="line">vlan 100</span><br><span class="line"> description to route</span><br><span class="line">vlan 200</span><br><span class="line"> description lan for home</span><br><span class="line"> name HOME_LAN</span><br><span class="line"> mac-vlan mac-address e45e-3732-xxxx priority 0</span><br><span class="line"> dhcp snooping enable</span><br><span class="line"> ipv4 source check user-bind enable</span><br><span class="line"> ipv6 source check user-bind enable</span><br><span class="line">vlan 210</span><br><span class="line"> description lan for guest</span><br><span class="line"> name GUEST_LAN</span><br><span class="line"> dhcp snooping enable</span><br><span class="line"> ipv4 source check user-bind enable</span><br><span class="line"> ipv6 source check user-bind enable</span><br><span class="line"> traffic-policy tp_vlan210-to-lan inbound</span><br><span class="line">vlan 220</span><br><span class="line"> description lan for IoT</span><br><span class="line"> name IoT_LAN</span><br><span class="line"> mac-vlan mac-address ec3d-fdbe-xxxx priority 0</span><br><span class="line"> dhcp snooping enable</span><br><span class="line"> ipv4 source check user-bind enable</span><br><span class="line"> ipv6 source check user-bind enable</span><br><span class="line"> traffic-policy tp_vlan210-to-lan inbound</span><br><span class="line">vlan 230</span><br><span class="line"> description intranet</span><br><span class="line"> name Intra_LAN</span><br><span class="line"> mac-vlan mac-address 345b-bb8f-xxxx priority 0</span><br><span class="line"> dhcp snooping enable</span><br><span class="line"> ipv4 source check user-bind enable</span><br><span class="line"> ipv6 source check user-bind enable</span><br><span class="line"> traffic-policy tp_permit-199 inbound</span><br><span class="line">vlan 1000</span><br><span class="line"> description ipv6 for lan</span><br><span class="line">interface Vlanif8</span><br><span class="line"> ip address 192.168.8.x 255.255.255.0</span><br><span class="line"></span><br><span class="line">interface Vlanif100</span><br><span class="line"> ip address 10.0.0.2 255.255.255.0</span><br><span class="line">interface Vlanif200</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0</span><br><span class="line"> dhcp select interface</span><br><span class="line"> dhcp server ip-range 192.168.1.x 192.168.1.x</span><br><span class="line"> dhcp server gateway-list 192.168.1.1</span><br><span class="line"> dhcp server dns-list 192.168.1.199 223.5.5.5 114.114.114.114</span><br><span class="line"> dhcp server logging allocation-fail allocation-success renew-success</span><br><span class="line">interface Vlanif210</span><br><span class="line"> ip address 192.168.21.1 255.255.255.0</span><br><span class="line"> dhcp select interface</span><br><span class="line"> dhcp server ip-range 192.168.21.x 192.168.21.x</span><br><span class="line"> dhcp server gateway-list 192.168.21.1</span><br><span class="line"> dhcp server dns-list 192.168.1.199 223.5.5.5 114.114.114.114</span><br><span class="line">interface Vlanif220</span><br><span class="line"> ip address 192.168.22.1 255.255.255.0</span><br><span class="line"> dhcp select interface</span><br><span class="line"> dhcp server ip-range 192.168.22.x 192.168.22.x</span><br><span class="line"> dhcp server gateway-list 192.168.22.1</span><br><span class="line"> dhcp server dns-list 192.168.1.199 223.5.5.5 114.114.114.114</span><br><span class="line"> dhcp server logging allocation-fail allocation-success renew-success</span><br><span class="line">interface Vlanif230</span><br><span class="line"> ip address 192.168.23.1 255.255.255.0</span><br><span class="line"> dhcp select interface</span><br><span class="line"> dhcp server ip-range 192.168.23.x 192.168.23.x</span><br><span class="line"> dhcp server gateway-list 192.168.23.1</span><br><span class="line"> dhcp server dns-list 192.168.23.1</span><br><span class="line"> dhcp server logging allocation-fail allocation-success renew-success</span><br></pre></td></tr></table></figure><p>各接口设置：</p><ul><li><p>G0&#x2F;0&#x2F;2: 上行链接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0/2</span><br><span class="line"> port link-type hybrid</span><br><span class="line"> port hybrid pvid vlan 100</span><br><span class="line"> undo port hybrid vlan 1</span><br><span class="line"> port hybrid tagged vlan 1000</span><br><span class="line"> port hybrid untagged vlan 100</span><br><span class="line"> loopback-detect enable</span><br><span class="line"> traffic-policy tp_dest-vlan210 inbound</span><br><span class="line"> traffic-policy tp_source-vlan210 outbound</span><br><span class="line"> dhcp snooping enable</span><br></pre></td></tr></table></figure></li><li><p>G0&#x2F;0&#x2F;6,G0&#x2F;0&#x2F;8: Eth-Trunk，连NAS链路聚合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface GigabitEthernet0/0/6</span><br><span class="line"> eth-trunk 1</span><br><span class="line">interface GigabitEthernet0/0/8</span><br><span class="line"> eth-trunk 1</span><br><span class="line">interface Eth-Trunk1</span><br><span class="line"> port link-type trunk</span><br><span class="line"> undo port trunk allow-pass vlan 1</span><br><span class="line"> port trunk allow-pass vlan 8 200 210 220 230 1000</span><br><span class="line"> loopback-detect enable</span><br><span class="line"> stp edged-port enable</span><br><span class="line"> dhcp snooping enable</span><br></pre></td></tr></table></figure></li><li><p>G0&#x2F;0&#x2F;1,G0&#x2F;0&#x2F;3,G0&#x2F;0&#x2F;4,G0&#x2F;0&#x2F;5,G0&#x2F;0&#x2F;7,G0&#x2F;0&#x2F;9-G0&#x2F;0&#x2F;12: 下行链接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface G0/0/x</span><br><span class="line"> energy-efficient-ethernet enable #SFP无</span><br><span class="line"> port-auto-sleep enable #SFP无</span><br><span class="line"> port link-type hybrid</span><br><span class="line"> port hybrid pvid vlan 210</span><br><span class="line"> undo port hybrid vlan 1</span><br><span class="line"> port hybrid tagged vlan 8</span><br><span class="line"> port hybrid untagged vlan 200 210 220 230</span><br><span class="line"> loopback-detect enable</span><br><span class="line"> stp edged-port enable</span><br><span class="line"> mac-vlan enable</span><br><span class="line"> dhcp snooping enable</span><br></pre></td></tr></table></figure></li></ul><p>OSPF及ACL策略：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ospf 1 router-id 10.0.0.2</span><br><span class="line"> area 0.0.0.0</span><br><span class="line">  network 10.0.0.0 0.0.0.255</span><br><span class="line"> area 0.0.0.1</span><br><span class="line">  network 192.168.1.0 0.0.0.255</span><br><span class="line">  network 192.168.21.0 0.0.0.255</span><br><span class="line">  network 192.168.22.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">traffic behavior tb_dest-vlan210</span><br><span class="line"> car cir 51200 pir 102400 cbs 6400000 pbs 12800000 mode color-blind green pass yellow pass red discard</span><br><span class="line">traffic behavior tb_dest-vlan220</span><br><span class="line"> car cir 5120 pir 10240 cbs 640000 pbs 1280000 mode color-blind green pass yellow pass red discard</span><br><span class="line">traffic behavior tb_source-vlan210</span><br><span class="line"> car cir 5120 pir 10240 cbs 640000 pbs 1280000 mode color-blind green pass yellow pass red discard</span><br><span class="line">traffic behavior tb_source-vlan220</span><br><span class="line"> car cir 5120 pir 10240 cbs 640000 pbs 1280000 mode color-blind green pass yellow pass red discard</span><br></pre></td></tr></table></figure><h2 id="SLM2008"><a href="#SLM2008" class="headerlink" title="SLM2008"></a>SLM2008</h2><p>交换机没有华为系的Hybrid接口，把连AP的口和上链口都设成同一个untagged vlan ID，这样可以靠上链交换机的MAC-VLAN功能进行VLAN划分。其他口我也没再划分其他VLAN的想法，都设成同一个untagged，只是上链口还有一个tagged vlan 8，这样可对其进行简单管理。</p><h2 id="Gen8"><a href="#Gen8" class="headerlink" title="Gen8"></a>Gen8</h2><p>哈，刚买Gen8的时候，少几个螺丝，跟客服沟通，我说买的G8（J8）少几个螺丝，那边哥们狂笑，连忙说Gen8（根8），哈哈哈。</p><p>硬件稍微升级了下，CPU&#x2F;E3-1265L V2，内存&#x2F;HPE SmartMemory 8Gx2，RAID卡&#x2F;Smart Array P222 Controller，硬盘&#x2F;SAS 4Tx4&#x2F;SSD 512G&#x2F;SD 8G。P222卡的温度还有点高，买了个4cm风扇，接主板里面的USB供电，从原来的70度降到47度左右，不知道夏天温度会怎样。</p><p>Host OS: <code>HPE-ESXi-6.7.0-Update3-19195723-iso-Gen9plus-670.U3.10.9.0.8 (Hewlett Packard Enterprise)</code>，安装在内置的8G SD卡，为了减少SD卡的写操作，将系统的log日志改写到其他Datasource里。</p><p>最开始的时候买了个PCIe转NVMe的卡，然后Datasource就放在这个盘里面。后来看到小黄鱼上面有4个4T的SAS盘，买回来后感觉还是超值的，2021年产，通电时间2年，写入只有30多G。为了这4个盘，所以买了P222卡（改成HBA模式），然后PCIe转NVMe的卡只能下岗。后面把SATA 5位置（ODD）升级为512G的SSD盘了，之前是一个12年买的Intel 40G :(，虽然接口速度只有SATA1，但用来安装Guest OS影响不大。然后Guest OS备份的话，可以直接挂载Guest OS的NFS成Datasource，将备份文件存到NFS里。</p><h3 id="Guest-OS"><a href="#Guest-OS" class="headerlink" title="Guest OS"></a>Guest OS</h3><ol><li>Alpine: Docker Image里经常看到的OS。这里最主要的作用是用来跑Docker aList，用来挂载中国移动的网盘，然后Debian挂载，备份文件存到网盘。最开始的时候是在Debian里面直接容器跑的，但是不能一启动就挂载，所以改到Alpine里面跑，然后把Alpine设置成随Host OS第一个启动，Debian延迟启动，这样就不用去搞脚本在Debian里延迟挂载，总感觉优雅，所以单独用Alpine提供aList网盘服务，Debian启动直接WebDav挂载。</li><li>Debian: 主力NAS系统。直通P222卡，挂载4个SAS盘。三张网卡，分别对应VLAN 200&#x2F;8&#x2F;1000，不限速网段&#x2F;管理网段&#x2F;IPv6网段。<br>2.1 提供SMB服务，TV Kodi给小孩看影片，通过Siri可<a href="/2023/02/18/remote-control-nas-samba/">远程开关服务</a>。<br>2.2 提供NFS服务，TV Kodi给大人看影片，呵呵，Kodi可设置多个profile，这样小孩默认profile默认是用SMB，而切换profile后默认是用NFS。 :)<br>2.3 Nextcloud容器，方便手机照片备份以及其他一些小资料存储<br>2.4 Navidrome容器，提供音频服务，硬盘里有一直存放的音乐，可以用手机播放，还能用CarPlay，很不错，解决了车上听歌的问题，不用再烦各种音乐播放软件<br>2.5 Pihole容器，提供内网DNS服务，解决部分广告及隐私收集问题，还有内网域名解析。<br>2.6 qBittorrent容器，主要用于PT下载。之前用的Transmission，几个CUI停更后，换成qBittorrent了。<br>2.7 其他，FRP内网穿透，Netty-Protobuf内网穿透（自己写的），Wireguard内网穿透，CURL脚本更新域名DNS IPv6地址，Nginx反代各二级域名访问内网以上各服务及iLO、ESXi等（同步VPS的SSL证书，并加简单认证），BorgBackup备份Debian系统、Nextcloud及个人资料并定时上传到网盘。</li><li>Win7: QQ或Wechat使用，远程给小孩打印作业 :)，并增加各网段网卡测试使用。</li><li>DSM7: 当时本来打印用作主力NAS的，因无法使用现有硬盘资料，且挂载的NFS无法使用各服务（当时主要想用Audio Station）。现在主要用来下载一些其他网盘的资料，比如OneDrive，GoogleDrive等。</li><li>FreeBSD: 想着用ZFS，但没法用Docker，又不想再去折腾Jail，放弃作主力NAS，当作测试使用。</li><li>Gentoo: 一直非常喜欢的一个发行版本，当时在上家单独，一直用它当主力开发系统。留着测试使用。</li><li>pfSense: 尝尝其他系统 :)</li></ol><h2 id="访问内网服务"><a href="#访问内网服务" class="headerlink" title="访问内网服务"></a>访问内网服务</h2><p>域名DNS设置：</p><ul><li>A Record: 设置成VPS的IPv4地址，然后NAS里设置FRP将Nginx端口映射到VPS，再在VPS的Nginx设置反代到FRP映射的端口，NAS里的Nginx通过二级域名访问各服务。<code>Internet --&gt; VPS Nginx --&gt; FRP --&gt; NAS Nginx --&gt; 各服务</code>。</li><li>AAAA Record: 因某国内最轻的VPS没有IPv6地址，NAS脚本每隔1小时更新此记录。这样可以直接SSH连到内网，或访问各服务。<code>Internet --&gt; NAS Nginx --&gt; 各服务</code>。</li><li>CNAME Record: 设置各服务的二级域名alias到前面A和AAAA记录上，这样只需改A和AAAA记录，服务的二级域名无需修改。</li></ul><p>主要参考：</p><ul><li><a target="_blank" rel="noopener" href="https://medium.com/@metalsecops/host-your-own-music-streaming-server-with-navidrome-6e4bdc9ae14b">Host Your Own Music Streaming Server with Navidrome</a></li><li><a target="_blank" rel="noopener" href="https://forums.unraid.net/topic/91922-convert-hp-smart-array-controller-to-hba-mode/">Convert HP Smart Array Controller to HBA Mode</a></li><li><a target="_blank" rel="noopener" href="https://samuel.kadolph.com/2015/02/mtu-and-tcp-mss-when-using-pppoe-2/">MTU and TCP MSS when using PPPoE</a></li><li><a target="_blank" rel="noopener" href="https://vk2.net/articles/Use-Aussie-Broadband-Framed-Route-on-a-Mikrotik-Router">Use Aussie Broadband’s Framed Route on a Mikrotik Router</a></li><li><a target="_blank" rel="noopener" href="https://sparktour.me/2023/10/18/mikrotik-routeros-openwrt-ipv6-prefix-delegation/">使用 Mikrotik RouterOS 和 Openwrt 在 ISP 获得的 IPv6 Prefix 上配置二级 PD</a></li><li><a target="_blank" rel="noopener" href="https://iecho.cc/2023/05/04/routeros-bullshit/">RouterOS 入门与最佳实践</a></li><li><a target="_blank" rel="noopener" href="https://hack-gpon.org/ont-fs-com-gpon-onu-stick-with-mac/">FS.com GPON ONU Stick with MAC (GPON-ONU-34-20BI)</a></li><li><a target="_blank" rel="noopener" href="https://hack-gpon.org/ont-nokia-g-010s-a/">Nokia G-010S-A</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2023/02/18/remote-control-nas-samba/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/02/18/remote-control-nas-samba/" class="post-title-link" itemprop="url">远程控制NAS开关Samba</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2023-02-18 13:18:56" itemprop="dateCreated datePublished" datetime="2023-02-18T13:18:56+08:00">2023-02-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="远程控制NAS开关Samba"><a href="#远程控制NAS开关Samba" class="headerlink" title="远程控制NAS开关Samba"></a>远程控制NAS开关Samba</h1><p>之前通过一些方法，可以用手机<a href="/2022/07/31/access-nas-via-ipv6/">控制家里的NAS</a>，开始的时候手动开关Samba服务，后来写了一个小Shell脚本，可以设置<a href="/2022/05/24/automatic-nas-samba-start-and-stop/">定时关闭Samba</a>，当时只考虑半个小时，后来呢可能其他需求，时间有变化，就在脚本后面加参数，控制关闭时间。后来有一天开车，无法用手机远程开Samba服务，就想到了NAS提供一个服务，外面调用就OK，然后手机用Siri语音远程调用。</p><h2 id="修改Shell脚本"><a href="#修改Shell脚本" class="headerlink" title="修改Shell脚本"></a>修改Shell脚本</h2><p>在原来的基础上，增加参数，可以调节时间。</p><figure class="highlight bash"><figcaption><span>g.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -gt 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;Too many args&#x27;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> == 0 ]; <span class="keyword">then</span></span><br><span class="line">    DEADTIME=$(<span class="built_in">date</span> -d <span class="string">&quot;+30 minutes&quot;</span> +<span class="string">&#x27;%H:%M&#x27;</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> == 1 ]; <span class="keyword">then</span></span><br><span class="line">    DEADTIME=$(<span class="built_in">date</span> -d <span class="string">&quot;+&quot;</span><span class="variable">$1</span><span class="string">&quot; minutes&quot;</span> +<span class="string">&#x27;%H:%M&#x27;</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">HOUR=$(<span class="built_in">echo</span> <span class="variable">$DEADTIME</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;:&#x27;</span> -f1)</span><br><span class="line">MINUTE=$(<span class="built_in">echo</span> <span class="variable">$DEADTIME</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;:&#x27;</span> -f2)</span><br><span class="line"></span><br><span class="line">sudo systemctl start smbd</span><br><span class="line"></span><br><span class="line">crontab -l 2&gt;/dev/null | <span class="built_in">head</span> -n -1 &gt; /tmp/crontemp</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$MINUTE</span> <span class="variable">$HOUR</span> * * * sudo systemctl stop smbd&quot;</span> &gt;&gt; /tmp/crontemp</span><br><span class="line">crontab /tmp/crontemp</span><br><span class="line"><span class="built_in">rm</span> /tmp/crontemp</span><br></pre></td></tr></table></figure><h2 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h2><p>现在访问家里的NAS有三个方式吧，一个是之前<a href="/2022/07/31/access-nas-via-ipv6/">IPv6的方式</a>，但是有的时候有些地方没有IPv6。另外一个方式就是<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">Frp</a>，VPS的一个端口访问NAS的SSH端口，另外一个方式就是NAS的<a href="/2018/11/18/use-ssh-proxy/">SSH Remote Tunnel</a>，再另外一个方式就是自己用Netty写了一个内网穿透的东东。</p><p>最终考虑的方式是Frp，简单，占用资源不多，可以SSH远程命令。</p><h2 id="对外服务"><a href="#对外服务" class="headerlink" title="对外服务"></a>对外服务</h2><p>有了内网穿透提供SSH，然后前面的Shell脚本，其实就比较简单了，<code>ssh -p port -i id_rsa username@ip cmd</code>，就可以直接调用NAS的Shell脚本了。</p><p>方式呢考虑了好几个：</p><ol><li>Nginx + Lua脚本，Nginx重新编译增加Lua支持，然后指定url运行脚本，<code>os.execute(&#39;cmd&#39;)</code>，Nginx增加Lua需要<a target="_blank" rel="noopener" href="https://github.com/openresty/lua-nginx-module#installation">下一些东西</a>， LuaJIT, ngx_devel_kit, ngx_lua, Nginx, lua-resty-core, lua-resty-lrucache，虽然本身Nginx是自己编译的，但是下这多东西，还是算了。</li><li>PHP，嗯，最好的编程语言 :(，本身一个老的VPS上面架了个Wordpress，是有PHP的，但是为了一些安全考虑，php配置文件中已经禁用了shell调用，为了一个功能也懒得打开了。</li><li>Java&#x2F;Golang&#x2F;C#&#x2F;Python，写个小的Web服务，用Nginx反代，调用Shell脚本。Python资源比较大，C#&#x2F;Java占用资源也比较大，就考虑用Golang写个简单的服务吧，直接调用Shell命令，后来查了下，可以连接SSH直接运行远程命令。</li></ol><h3 id="运行shell"><a href="#运行shell" class="headerlink" title="运行shell"></a>运行shell</h3><figure class="highlight golang"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        gin.SetMode(gin.ReleaseMode)</span><br><span class="line">        router := gin.Default()</span><br><span class="line">        router.GET(<span class="string">&quot;/tv/tv&quot;</span>, openTV)</span><br><span class="line">        router.GET(<span class="string">&quot;/tv/tv/:min&quot;</span>, openTV)</span><br><span class="line"></span><br><span class="line">        router.Run(<span class="string">&quot;:8888&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">openTV</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        minParam := c.Param(<span class="string">&quot;min&quot;</span>)</span><br><span class="line">        x := <span class="type">int64</span>(<span class="number">35</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> min, err := strconv.ParseInt(minParam, <span class="number">10</span>, <span class="number">32</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            x = min</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cmd := exec.Command(<span class="string">&quot;ssh&quot;</span>, <span class="string">&quot;-p&quot;</span>, <span class="string">&quot;10000&quot;</span>, <span class="string">&quot;-i&quot;</span>, <span class="string">&quot;/home/liangwu/.ssh/id_rsa&quot;</span>, <span class="string">&quot;liangwu@127.0.0.1&quot;</span>, <span class="string">&quot;~/g.sh&quot;</span>, strconv.Itoa(<span class="type">int</span>(x)))</span><br><span class="line"></span><br><span class="line">        result, err := cmd.Output()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(err)</span><br><span class="line">            c.IndentedJSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;wrong&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resultString := <span class="type">string</span>(result[:])</span><br><span class="line">        c.IndentedJSON(http.StatusOK, gin.H&#123;<span class="string">&quot;result&quot;</span>: resultString&#125;)</span><br></pre></td></tr></table></figure><h3 id="连接SSH"><a href="#连接SSH" class="headerlink" title="连接SSH"></a>连接SSH</h3><script src="//gist.github.com/201a508d4c1c57e6b93042ae96b1b508.js?file=gin-ssh.go"></script><h2 id="Siri语音指令"><a href="#Siri语音指令" class="headerlink" title="Siri语音指令"></a>Siri语音指令</h2><p>Shortcuts新增指令，名字可以直接用Siri打开，比如Shortcuts命名为<code>打开电视</code>，直接用<code>Hi Siri 打开电视</code>就可以执行。</p><ul><li>Ask for Input，’Ask for <code>Number</code> with <code>How much time?</code>‘</li><li>Text, ‘host&#x2F;tv&#x2F;tv&#x2F;<code>Provided Input</code>‘</li><li>Safari Open URLs, ‘Open <code>Text</code>‘</li></ul><p>OK，这样就可以Siri打开家里电视咯。。。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2022/10/18/s7-communication/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/10/18/s7-communication/" class="post-title-link" itemprop="url">西门子S7通信</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-10-18 23:15:59" itemprop="dateCreated datePublished" datetime="2022-10-18T23:15:59+08:00">2022-10-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="心酸之路"><a href="#心酸之路" class="headerlink" title="心酸之路"></a>心酸之路</h2><p>去年下半年左右开始搞一些与西门子PLC通信的事情，也补了一些PLC编程知识，相信有一些编程基础的人，学PLC编程应该会很快的，尤其有一些C基础。</p><p>但是呢原来的程序一直一直是用OPC DA的方式与PLC通信，看了下代码质量确实不高，近20年前的代码，反正能运行读取数据，也没有重构的动力。</p><p>怎么工作的呢？有一个配置程序进行地址配置</p><ol><li>配置PLC地址串，连接方式</li><li>配置所有需要用到的变量，地址，数据类型，存在数据库一张表中</li><li>配置变量组，从上步中选取各变量，存在数据库一张表中</li><li>在程序中对应各变量组建立相应类，用于读写数据</li><li>配置连接，变量组等</li><li>变量组读到的数据通过for循环，每次用switch判断字符串，然后硬编码对应到对象的字段中去，还需要硬编码类型转换</li></ol><p>总之这个过程非常非常不优雅，太多模版代码，还有太多硬编码，既然已经配置好了地址对应的数据类型，为什么还需要硬编码转类型呢？而且当时里面用的EF读写数据库，那种操作真的是快让人吐，正常一个查询搞定的事，代码硬生生读取十几次数据库，然后很多读写数据库，速度慢得吓人。怎么做的呢？先查表按过滤条件，把id全找出来，对，只有id，然后对id列表用for循环，再用id去查数据库，一次查一条数据，再组装数据到对象中去，感觉完全不像是在用ORM框架。想死的心都有，完完全全不想动这些代码。</p><p>尝试过的S7通信方式：</p><ol><li>HslCommunication，感觉很全面，但是好像要付费，pass，国人写的</li><li>OPC UA Helper，用的OPC基金UA Client的包，然后西门子官网上有个Helper示例，试了试，还OK，但是需要PLC开启OPC UA功能，或用Kepware软件</li><li>s7netplus，比较不错，自己包装包装可以用得比较顺手，后面几个小项目用的是它</li><li>Eclipse Milo，OPC UA方式读写数据，未仔细研究，OPC UA方式暂时放弃</li><li>s7connector, Java，想着C#还不是很精通，用Java来试试，蛮久没有更新，没找到批量读取的功能。</li><li>plc4x，netty, SPI, opm, connection-pool, byte-buddy, 暂时发现还蛮合适的。</li></ol><h2 id="开整"><a href="#开整" class="headerlink" title="开整"></a>开整</h2><p>最开始的时候学习官方的方式，OPM，类似ORM，读取的数据直接映射到对象。</p><p>新建对象，类加上注解，字段加上注解并填上地址、类型，创建连接，ByteBuddy创建动态对象，拦截get&#x2F;set方法。get方法，判断是否在缓存时间内，如果在则直接返回缓存值，不在则从PLC中读取新值。set方法，直接写入值到PLC。这里有两个地方有坑，其它无参方法则会先读取所有PLC值，执行原无参方法，再将值写入PLC；其它一个参数方法，则会先读取PLC值，再执行原方法。这两点看源码能清楚，所以感觉Java这块比C#要好一些，随时能清楚代码干了什么事情，而不是包装得不清楚怎么实现的。</p><h3 id="动态类"><a href="#动态类" class="headerlink" title="动态类"></a>动态类</h3><p>了解了规则后，自己按照类型方法开整。</p><p>读取yml文件，两大配置，一是PLC地址，包含需要读取的数据列表；二是数据说明，TagName，地址，数据类型，转换类型，比例等。根据“数据说明”配置，生成动态类，加类注解<code>@PLCEntity</code>，字段加注解<code>@PLCField</code>并地址和缓存时间填入，生成相应get&#x2F;set方法，生成一个方法，带一个参数，用于从PLC读取所有字段值（从OPM源码了解有此功能）。</p><p>生成另一个动态类，和第一个动态类类似，但不增加注解，再增加另外2个字段，数据更新时间和PLC标识，用于写入数据库。另外如有比例变换，增加变换后的get方法，处理比例逻辑。现场间断生成，可能一些数值几个小时内都不会变化，如果采集数据都写入数据库，会有很多无效数据。后面新读的值与旧值比较，如果一样，则不写入数据库。从PLC读到值写入第一个动态生成的类对象，然后复制到第二个动态生成的类对象，此时后者多两个字段，是变化的，所以比较新旧值的时候，<code>hashCode</code>和<code>equals</code>方法将这两个字段值去掉。嗯，现场效果还可以。但是young GC比较多，可能与机制相关，频繁读取数据，生成新对象。</p><h3 id="改变策略"><a href="#改变策略" class="headerlink" title="改变策略"></a>改变策略</h3><p>前面的方法熟悉了bytebuddy的使用，以后写框架会有一些好处吧。</p><p>后面想了想，感觉没有必要生成动态类，直接用Map应该就可以了。嗯，MongoDB的bson里面有个Document很合适，写入数据后直接插入到MongoDB。新代码写完了，但是学没有到现场测试效果。不知道young GC会不会少一些。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2022/07/31/access-nas-via-ipv6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/07/31/access-nas-via-ipv6/" class="post-title-link" itemprop="url">IPv6访问NAS</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-07-31 23:17:00" itemprop="dateCreated datePublished" datetime="2022-07-31T23:17:00+08:00">2022-07-31</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>嗯嗯，拖了好久没有把这个发出来了。自从移动可以用IPv6后，想办法可以在外面用IPv6访问自家NAS，主要是用<code>transmission</code>下载，然后<code>Nextcloud</code>保存手机上的照片。基本上这些功能已经实现，但是中间也碰到了一些问题。思路就是将域名<code>AAAA</code>记录改为当前NAS的IPv6地址。正好DigitalOcean的有这个功能，提供了API，可以用API修改域名记录。</p><ol><li>网络结构</li></ol><p>家里网络是一光猫，桥接，后面连一个Buffalo的路由器（刷了OpenWRT），然后一个CISCO千兆非网管的交换机，再接到各终端设备。无线用的是新的华为新的AX6路由器，当一个无线接入点AP。这里提一点是，光猫比较早了，大概是2016年办的，烽火HG266GU，有个大坑，后面LAN口只有LAN1口是千兆，其他是百兆，当时升级宽带的时候速率一直达不到要求，后来找移动才知道。还有一个无线的问题，当时用的是TP-LINK AC1200，用无线下NAS的东西，最大只有4MB&#x2F;s，用Wireshark抓包，一直有丢包，速度上不去，换了它后一切都好了，笔记本Intel AX210网卡2402&#x2F;2402Mbps，测试到NAS的网速，卡在1000Mbps，卡在有线网络上了，当然从NAS下东西速率还是卡在硬盘上面。</p><ol start="2"><li>路由器设置</li></ol><p>此时Buffalo的路由器成了上网关键设备，设置好IPv4防火墙，保证网络安全，禁止内网非法设备上网。暂时IPv6防火墙没有太多规则，考虑到现在IPv6可能被扫的机率比较低。</p><ol start="3"><li>DigitalOcean设置</li></ol><p>可以在<a target="_blank" rel="noopener" href="https://docs.digitalocean.com/reference/api/create-personal-access-token/">DO界面</a>生成新的API Token，这样就可以利用API来远程修改DNS信息。具体方法可以参考<a target="_blank" rel="noopener" href="https://docs.digitalocean.com/reference/api/api-reference">官方文档</a>。可以用cURL，Python等，当时可能正在用Python，所以后来我就用Python来修改DNS记录了。其中用到了<a target="_blank" rel="noopener" href="https://github.com/koalalorenzo/python-digitalocean">python-digitalocean</a>，主要是用到了<code>Listing records of a domain/Update a domain record</code>。在DigitalOcean的DNS管理界面，设置一条<code>AAAA</code>的记录，后面脚本会根据NAS实际IPv6的地址进行修改。</p><ol start="4"><li>获取NASIPv6地址</li></ol><p>这部分是修改最多的地方吧，最开始也是用Python来获取IPv6地址，但是不太理想，NAS的IPv6地址有很多，其中临时的IPv6大概是一段时间就会失效，然后会生成一个新的IPv6地址，这里查本机IPv6地址会有很多。</p><p>后来改成用SHELL脚本来搞。拿到网卡的所有IPv6地址，去掉link环路，过时地址，临时地址这时候大概会获取1到2个地址。基本可用，然后得到的地址传给Python脚本去修改DO的DNS记录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPs=`ip -6 addr show enp1s0 | grep inet6 | grep -v -E <span class="string">&quot;link|host|deprecated|temporary&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F<span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br></pre></td></tr></table></figure><p>后来发现一个问题，因为路由器重启的话，IPv6地址会有上次拨号的记录和这次拨号的记录，会导致<code>AAAA</code>记录错误。后来想了一些办法没成功，最后来了个最笨的办法，直接从路由器拿到最的IPv6地址，跟NAS的地址进行对比，这样DNS就可以更新成最新的记录了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPPre=`ssh -p PORT root@IPADDR ip -6 addr show br-lan | grep inet6 | grep -v -E <span class="string">&quot;link|host&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F<span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | awk -F<span class="string">&#x27;::&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br></pre></td></tr></table></figure><script src="//gist.github.com/05fa0e623962c612d59b23a06797da7e.js?file=updateNasDNS.sh"></script><script src="//gist.github.com/05fa0e623962c612d59b23a06797da7e.js?file=updateNasDNS.py"></script></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2022/07/03/export-conda-env/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/07/03/export-conda-env/" class="post-title-link" itemprop="url">导出conda环境</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-07-03 00:14:12" itemprop="dateCreated datePublished" datetime="2022-07-03T00:14:12+08:00">2022-07-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>最近碰到一个问题，使用Keras，Tensorflow在某厂里进行机器学习，把现场的数据拷到自己电脑里面，然后学习了一段时间，实验了下下，发现还行吧，准备把东西放到内网里面，再加个FastAPI提供个服务给其它程序调用，本来想用GRPC的，想想算了，也没有太高的要求，能用就OK，懒得麻烦，HTTP省心一些。</p><p>但是但是，这鬼是个内网，不能下载对应的包，心中一万匹马跑过。自己电脑虚拟机搞个Windows，然后把环境搭好，到能上网的地方把依赖下载好，直接拷贝好像不行哦。</p><p>于是上网搜了搜，有一个包<code>conda-pack</code>可以直接用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda install -c conda-forge conda-pack</span><br><span class="line">conda pack -n my_env -o my_env.tar.gz</span><br></pre></td></tr></table></figure><p>把<code>my_env.tar.gz</code>拷到内网机器里面，然后搞个批处理文件就可以工作了。</p><figure class="highlight cmd"><figcaption><span>startup.bat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">cd</span> my_env</span><br><span class="line"><span class="keyword">call</span> bin\activate.bat</span><br><span class="line">python main.py</span><br></pre></td></tr></table></figure><p>其实还有其他方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本机</span></span><br><span class="line">conda create --name snapshot --<span class="built_in">clone</span> myenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># spec list</span></span><br><span class="line">conda list --explicit spec-list.txt</span><br><span class="line"></span><br><span class="line">conda create --name python-course --file spec-list.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment.yml</span></span><br><span class="line">conda <span class="built_in">env</span> <span class="built_in">export</span> environment.yml</span><br><span class="line">conda <span class="built_in">env</span> create -f environment.yml</span><br></pre></td></tr></table></figure><p>ref:</p><ul><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/54192462/how-to-package-conda-env-into-one-single-file">How to package conda env into one single file?</a></li><li><a target="_blank" rel="noopener" href="https://conda.github.io/conda-pack/">Conda-Pack</a></li><li><a target="_blank" rel="noopener" href="https://www.anaconda.com/blog/moving-conda-environments">Moving Conda Environments</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2022/05/24/automatic-nas-samba-start-and-stop/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/05/24/automatic-nas-samba-start-and-stop/" class="post-title-link" itemprop="url">自动处理NAS的Samba关闭</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-05-24 19:28:33" itemprop="dateCreated datePublished" datetime="2022-05-24T19:28:33+08:00">2022-05-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>家里整了NAS，后来移动有了IPv6，通过修改DNS信息，自动更新域名对应的IPv6地址，这样可以在外面直接控制NAS。里面下了不少动画片给小孩看，家里设备上网需要在OpenWrt里进行设置才可以，电视机很早就屏蔽了上网功能，所以小孩打开电视也没有用。以前试过通过<code>cron</code>来定时开启和关闭SMB，让小孩定时看动画片，可是有时候上兴趣班之类的过了时间，还是需要手动打开，然后修改<code>cron</code>增加定时关闭SMB，操作多一些，后来想了下，应该还可以再简化，记录一下吧。</p><p>最早之前是有想法的，比如下午5点定时打开SMB，然后监测SMB连接情况，到达30分钟后，自动关闭SMB。当时搜了下，好像没有特别好的方案，才有了上面的手动方式。后来换了下思路，以开启SMB时间为准，30分钟后自动关闭，写一个shell脚本完成。</p><figure class="highlight bash"><figcaption><span>smb.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line"></span><br><span class="line">DEADTIME=$(<span class="built_in">date</span> -d <span class="string">&quot;+30 minutes&quot;</span> +<span class="string">&#x27;%H:%M&#x27;</span>)</span><br><span class="line">HOUR=$(<span class="built_in">echo</span> <span class="variable">$DEADTIME</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;:&#x27;</span> -f1)</span><br><span class="line">MINUTE=$(<span class="built_in">echo</span> <span class="variable">$DEADTIME</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;:&#x27;</span> -f2)</span><br><span class="line"></span><br><span class="line">sudo systemctl start smbd</span><br><span class="line"></span><br><span class="line">crontab -l 2&gt;/dev/null | <span class="built_in">head</span> -n -1 &gt; /tmp/mycron</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$MINUTE</span> <span class="variable">$HOUR</span> * * * sudo systemctl stop smbd&quot;</span> &gt;&gt; /tmp/mycron</span><br><span class="line">crontab /tmp/mycron</span><br><span class="line"><span class="built_in">rm</span> /tmp/mycron</span><br></pre></td></tr></table></figure><p>需要设置下用户权限，可以使用<code>sudo systemctl</code>不用输密码</p><figure class="highlight plaintext"><figcaption><span>/etc/sudoers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">liangwu ALL=(ALL:ALL) NOPASSWD:/usr/bin/systemctl</span><br></pre></td></tr></table></figure><p>现在就是小孩需要看电视的时候，用手机SSH登录到NAS，执行下脚本就不管了。后期考虑VPS暴露一个WEBAPI，输入一个地址加密钥完成脚本执行，嗯嗯 :)</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2021/12/02/notes_202112/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/12/02/notes_202112/" class="post-title-link" itemprop="url">随手记</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-12-02 21:52:29" itemprop="dateCreated datePublished" datetime="2021-12-02T21:52:29+08:00">2021-12-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>这段时间整了一点东西，也有几点是重复查资料的事情，所以需要记录下，方便自己查找。</p><h2 id="Windows端口转发"><a href="#Windows端口转发" class="headerlink" title="Windows端口转发"></a>Windows端口转发</h2><p>回本行后，基本服务器、客户端都是Windows的天下了，有的企业内部网络环境比较恶心，偶尔需要用到转口转发，这个在<a href="/2018/11/18/use-ssh-proxy/">Linux下面是很好解决的</a>，直接SSH就可以了。很早以前在医院也用Windows整过端口转发，后来忘掉，查了查<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-interface-portproxy">文档</a>，查命令的帮助还是能解决一部分问题的。相当于<code>ssh -L</code>。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenaddress=<span class="number">127.0</span>.<span class="number">0.1</span> listenport=<span class="number">9000</span> connectaddress=<span class="number">192.168</span>.<span class="number">0.10</span> connectport=<span class="number">80</span></span><br></pre></td></tr></table></figure><h2 id="Netty内网穿透"><a href="#Netty内网穿透" class="headerlink" title="Netty内网穿透"></a>Netty内网穿透</h2><p>现在用的内网穿透是<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a>，还是很好用的，应该是因为安全的原因，有个我比较需要的功能没有，就是可以在服务端或另一客户端在线确定何种类型何种端口转发。某企业服务器已经内网连到公网服务器，而自己的电脑连上服务器后，可以在线确定本地、远程或动态端口转发。</p><p>前两个月断断续续地用Netty做了一部分工作，本地端口转发功能已经完成了，待完善后面两个转发。后面如果代码写得还OK的话，估计发github上面吧，好像github注册之后一直没有真正地往上面堆代码。</p><h2 id="福建中兴F452光猫超级密码"><a href="#福建中兴F452光猫超级密码" class="headerlink" title="福建中兴F452光猫超级密码"></a>福建中兴F452光猫超级密码</h2><p>之前在福建出差，用的是电信网络，一般都可以通过修改光猫的配置来启用IPv6，这样可以直接连家里的NAS拖电影看，很多光猫的超级密码比较好获得，但是有次碰了一个中兴F452，搞了几个小时才搞定，记录下吧。</p><p>看了<a target="_blank" rel="noopener" href="https://www.cnmoci.com/thread-803-1-1.html">一个帖子</a>，可以用普通用户登录后下载一个文件，然后用工具把超级密码给读出来，后来换了一个房间这个工具不能用了。想了想，工具应该是没有问题的，估计是文件有问题，后面也验证了这个想法。放狗搜了搜，这个工具也是在一个论坛的兄弟整的，<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1005978-1-1.html">详细写了那个配置文件的解法</a>。</p><p>他是Delphi写的，16年前用过Delphi，看起来还好，文件如何解也有详细説明，正好现在在熟悉C#，不如直接开干吧。这里有个插曲，就是丫有个Nuget包的ZLib解包居然有问题，浪费了近两个小时。。。最后用的包是<code>Zlib.Portable</code>。</p><p>写完后，验证了之前的想法，就是下载下来的配置文件有问题，不完整，所以真好解一部分就把这部分存起来。还好可以分段解包。</p><script src="//gist.github.com/71415db0ab0689e3d6e5abcfe02f49f4.js?file=Program.cs"></script><h2 id="Samba链接共享问题"><a href="#Samba链接共享问题" class="headerlink" title="Samba链接共享问题"></a>Samba链接共享问题</h2><p>之前家里NAS是把整个BTDownloads的目录共享的，小孩认识几个字后，很快就能在电视机上操作<code>Kodi</code>，视频，BTDownloads，汪汪队，一顿操作很熟练啊。于是就想把小孩喜欢的几个动画片的英文版搞到一上目录下，但是这几个英文版还在做种中，不想再动。就想能不能新建目录，然后用symlinks，但是发现不能正常工作，后来查了下<a target="_blank" rel="noopener" href="https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html#WIDELINKS">文档</a>，解决了这个问题，可以让小孩只看英文版的动画片，而不影响原来所有的东西。</p><figure class="highlight plaintext"><figcaption><span>/etc/samba/smb.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">allow insecure wide links = yes</span><br><span class="line"></span><br><span class="line">[share]</span><br><span class="line">follow symlinks = yes</span><br><span class="line">wide links = yes</span><br></pre></td></tr></table></figure><h2 id="最后一个月"><a href="#最后一个月" class="headerlink" title="最后一个月"></a>最后一个月</h2><p>最后一个月了，今年的计划完成了吗？好像没有， :(</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2021/09/14/vue-echarts-memory-leak/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/09/14/vue-echarts-memory-leak/" class="post-title-link" itemprop="url">Vue.js使用ECharts内存泄漏问题</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-09-14 23:41:12" itemprop="dateCreated datePublished" datetime="2021-09-14T23:41:12+08:00">2021-09-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>前段见时间有个项目，自己想尽可能查看现场各设备的运行参数，显示一些统计信息，之前同事用C#写了个画面的，但感觉不灵活，换个项目，要改的东西就很多，界面基本需要重画。后来想起之前用ECharts做过电子在屏的，应该展示效果会更好。之前考虑用React做前端的，后来想想就一个页面，直接用Vue干吧，正好Vue也升级到3了，然后用Electron做个包装，也不用再下浏览器。记录下碰到的问题吧。</p><h2 id="ElementUI按需引入"><a href="#ElementUI按需引入" class="headerlink" title="ElementUI按需引入"></a>ElementUI按需引入</h2><p>之前Vue用的脚手架是<code>vue-cli</code>，统计时间是比较长的，升级到3之后，改用<code>vite</code>了，很方便。因为使用的组件不多，把ElementUI全部引入的话，JS文件会比较大，所以只引入使用的几个组件。参照<a target="_blank" rel="noopener" href="https://element-plus.org/#/zh-CN/component/quickstart">官方文档</a>。</p><figure class="highlight js"><figcaption><span>main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-plus/lib/theme-chalk/index.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">ElButton</span>,</span><br><span class="line">    <span class="title class_">ElCol</span>,</span><br><span class="line">    <span class="title class_">ElInputNumber</span>,</span><br><span class="line">    <span class="title class_">ElProgress</span>,</span><br><span class="line">    <span class="title class_">ElRow</span>,</span><br><span class="line">    <span class="title class_">ElDescriptions</span>,</span><br><span class="line">    <span class="title class_">ElDescriptionsItem</span>,</span><br><span class="line">  &#125; <span class="keyword">from</span> <span class="string">&#x27;element-plus&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> plugins = [</span><br><span class="line">      <span class="title class_">ElRow</span>,</span><br><span class="line">      <span class="title class_">ElCol</span>,</span><br><span class="line">      <span class="title class_">ElButton</span>,</span><br><span class="line">      <span class="title class_">ElDescriptions</span>,</span><br><span class="line">      <span class="title class_">ElDescriptionsItem</span>,</span><br><span class="line">      <span class="title class_">ElInputNumber</span>,</span><br><span class="line">      <span class="title class_">ElProgress</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"></span><br><span class="line">plugins.<span class="title function_">forEach</span>(<span class="function"><span class="params">plugin</span> =&gt;</span> &#123;</span><br><span class="line">    app.<span class="title function_">use</span>(plugin)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$ELEMENT</span> = &#123; <span class="attr">size</span>: <span class="string">&#x27;small&#x27;</span>, <span class="attr">zIndex</span>: <span class="number">3000</span> &#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="ECharts"><a href="#ECharts" class="headerlink" title="ECharts"></a>ECharts</h2><h3 id="按需引入"><a href="#按需引入" class="headerlink" title="按需引入"></a>按需引入</h3><p>ECharts升级到5之后，与之前的引入有一点区别，具体可参考<a target="_blank" rel="noopener" href="https://echarts.apache.org/handbook/zh/basics/release-note/v5-upgrade-guide/">官方文档</a></p><figure class="highlight js"><figcaption><span>linechart.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> echarts <span class="keyword">from</span> <span class="string">&#x27;echarts/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BarChart</span>, <span class="title class_">LineChart</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;echarts/charts&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CanvasRenderer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;echarts/renderers&#x27;</span> <span class="comment">// CanvasRenderer, SVGRenderer</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">GridComponent</span>, <span class="title class_">TooltipComponent</span>, <span class="title class_">TitleComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;echarts/components&#x27;</span></span><br><span class="line"><span class="comment">// require(&#x27;echarts/theme/macarons&#x27;) // echarts theme</span></span><br><span class="line"><span class="keyword">import</span> resize <span class="keyword">from</span> <span class="string">&#x27;./mixins/resize&#x27;</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">&#x27;moment&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="VUE中引入ECharts"><a href="#VUE中引入ECharts" class="headerlink" title="VUE中引入ECharts"></a>VUE中引入ECharts</h3><p>最开始在VUE中引入ECharts老是报错，后来查了下，应该是DOM没有准备好，具体参考的应该是<a target="_blank" rel="noopener" href="https://github.com/PanJiaChen/vue-element-admin">vue-element-admin</a>里面的配置来着。应该用<code>nextTick()</code>，待DOM准备好之后，ECharts绑定到DOM。</p><figure class="highlight js"><figcaption><span>LineChart.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">chart</span> = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// chart: null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initChart</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">methods</span>: &#123;</span><br><span class="line">  <span class="title function_">initChart</span>(<span class="params"></span>) &#123;</span><br><span class="line">    echarts.<span class="title function_">use</span>([<span class="title class_">BarChart</span>, <span class="title class_">LineChart</span>, <span class="title class_">GridComponent</span>, <span class="title class_">TooltipComponent</span>, <span class="title class_">TitleComponent</span>, <span class="title class_">CanvasRenderer</span>])</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chart</span> = echarts.<span class="title function_">init</span>(<span class="variable language_">this</span>.<span class="property">$el</span>) <span class="comment">// 因为这个组件只有一个div展示图片，所以用this.$el，如果是其它，可使用this.refs..$el</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chart</span>.<span class="title function_">setOption</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">title</span>: &#123;</span><br><span class="line">          <span class="attr">text</span>: <span class="string">&#x27;title&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">grid</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="attr">left</span>: <span class="number">50</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="number">50</span>,</span><br><span class="line">            <span class="attr">bottom</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">containLabel</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">axisPointer</span>: &#123;</span><br><span class="line">          <span class="attr">link</span>: &#123;<span class="attr">xAxisIndex</span>: <span class="string">&#x27;all&#x27;</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">xAxis</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// id: &#x27;x1&#x27;, 解决内存泄漏</span></span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;category&#x27;</span>,</span><br><span class="line">            <span class="attr">boundaryGap</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">axisPointer</span>: &#123;</span><br><span class="line">              <span class="attr">type</span>: <span class="string">&#x27;shadow&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">splitLine</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">interval</span>: <span class="number">9</span>,</span><br><span class="line">              <span class="attr">lineStyle</span>: &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;dashed&quot;</span>,</span><br><span class="line">                <span class="attr">color</span>: <span class="string">&quot;rgba(0, 0, 0, 1)&quot;</span>,</span><br><span class="line">                <span class="attr">shadowBlur</span>: <span class="number">2</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;x2&#x27;,</span></span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;category&#x27;</span>,</span><br><span class="line">            <span class="attr">boundaryGap</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;top&#x27;</span>,</span><br><span class="line">            <span class="attr">axisLabel</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">tooltip</span>: &#123;</span><br><span class="line">          <span class="attr">trigger</span>: <span class="string">&#x27;axis&#x27;</span>,</span><br><span class="line">          <span class="attr">axisPointer</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">            <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">yAxis</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;y1&#x27;,</span></span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;y1&#x27;</span>,</span><br><span class="line">            <span class="attr">max</span>: <span class="number">900</span>,</span><br><span class="line">            <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">interval</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">axisLabel</span>: &#123;</span><br><span class="line">              <span class="attr">formatter</span>: <span class="string">&#x27;&#123;value&#125; °C&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">axisTick</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">axisLine</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">splitLine</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;y2&#x27;,</span></span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;y2&#x27;</span>,</span><br><span class="line">            <span class="attr">axisLabel</span>: &#123;</span><br><span class="line">              <span class="attr">formatter</span>: <span class="string">&#x27;&#123;value&#125; min&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">axisTick</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">axisLine</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">splitLine</span>: &#123;</span><br><span class="line">              <span class="attr">show</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;y3&#x27;,</span></span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;y3&#x27;</span>,</span><br><span class="line">            <span class="attr">inverse</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">show</span>: <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">series</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;s1&#x27;,</span></span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;s1&#x27;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;bar&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;s2&#x27;,</span></span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;s2&#x27;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">            <span class="attr">yAxisIndex</span>: <span class="number">1</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//id: &#x27;s3&#x27;,</span></span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;s3&#x27;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;bar&#x27;</span>,</span><br><span class="line">            <span class="attr">xAxisIndex</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">yAxisIndex</span>: <span class="number">2</span>,</span><br><span class="line">          &#125;]</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chart</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;series&#x27;</span>, <span class="function"><span class="params">params</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.$emit(<span class="string">&#x27;click&#x27;</span>, <span class="built_in">parseInt</span>(params.<span class="property">name</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h3><p>参照ECharts的样例做好了一个动态更新的图表，每秒从后台拉下数据进行更新，还蛮好看的。可是过两天后发现浏览器或者Electron内存暴了，直接把系统快干死。当时不清楚哪里的问题，以为是每秒获取数据后处理有问题，检查了好久都没办法解决，最后只好排除法，页面上的东西一个个排除观察一段时间看内存是不是一直往上涨，最后定位到ECharts。上网查了下，发现有提到的<code>echarts.clear()</code>或<code>echarts.dispose()</code>，感觉这个有点不靠谱，这样子那不是每次echarts都需要重新生成？反正也试了，确实效果不好，图表都是重新生成，不能连续变化。</p><p>没办法，查<a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/api.html#echartsInstance.setOption">文档</a>吧，最后还真发现了些什么。里面有个<code>组件合并模式</code>，就是每次数据变化后都会调用一次<code>this.echarts.setOption()</code>，因为设置不当，数据一直往图表里面填，没有释放旧数据。其实解决办法很简单，就是把有变动的地方设置好ID，每次更新就更新带ID的数据。</p><figure class="highlight js"><figcaption><span>LineChart.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">chart</span>.<span class="title function_">setOption</span>(</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">xAxis</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;x1&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: xArray</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;x2&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: xArray,</span><br><span class="line">    &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">yAxis</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;y2&#x27;</span>,</span><br><span class="line">        <span class="attr">max</span>: <span class="title class_">Math</span>.<span class="title function_">max</span>(...stayTimes.<span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> !<span class="built_in">isNaN</span>(e))),</span><br><span class="line">        <span class="attr">min</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(...stayTimes.<span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> !<span class="built_in">isNaN</span>(e))),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;y3&#x27;</span>,</span><br><span class="line">        <span class="attr">max</span>: <span class="title class_">Math</span>.<span class="title function_">max</span>(...stayTimesDelta.<span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> !<span class="built_in">isNaN</span>(e))) * <span class="number">10</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">series</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;s1&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: chargeTemps</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;s2&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: stayTimes</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;s3&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: stayTimesDelta</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2021/08/04/openwrt-on-nas/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/08/04/openwrt-on-nas/" class="post-title-link" itemprop="url">Nas使用VirtualBox安装OpenWrt当软路由</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-08-04 20:57:41" itemprop="dateCreated datePublished" datetime="2021-08-04T20:57:41+08:00">2021-08-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h1><p>之前家里是光纤通过运营商的光猫桥接，然后一个路由器拨号，再连一个交换机。因为之前已经搞了台NAS，之前一直想整台HP Gen8的，有iLO管理口，再加上eSXi虚拟化，搞个软路由和NAS，这样比较完美。后面没买到便宜的Gen8，现在考虑功耗比较大，软Raid导致噪音比较大，就算了没整Gen8了。看看后面能不能换个大House，整个小的机柜，再搞个服务器玩玩吧。</p><p>现在路由器、交换机和NAS在一个小小的工具箱里面，夏天温度有点高，想想看把软路由整到NAS里面去吧。NAS用的OS是OMV5，基于Debian，比较熟悉，整个虚拟机安装OpenWrt应该是一个可行的方案。KVM一直不是太熟悉，直接用VirtualBox，之前VirtualBox没用过CLI，正好供机会学习下CLI控制。</p><p>这样的好处就是不用再单独开一个硬件路由器了，减少了一点点电费和热量，然后性能会强一些；缺点就是Host OS挂掉的话，就全屋不能上网了。</p><p>主要参考三篇官方文章<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/virtualization/virtualbox-vm">OpenWrt on VirtualBox HowTo</a>,<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/virtualization/virtualbox-advanced">VirtualBox Advanced</a>,<a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/">VirtualBox Manual</a></p><h2 id="构架"><a href="#构架" class="headerlink" title="构架"></a>构架</h2><p>NAS主板有一个千兆电口，然后自己备了一个PCI双网卡，但是因为主板的原因，PCI网卡的最高速率好像只有400M，所以想的就是一个PCI的口连ISP，板载千兆电口连交换机，多一个口备用。</p><p>Host OS Debian里面将板载网卡（enp1s0）设置成静态IP(192.168.1.2&#x2F;32)，PCI网卡（enp6s0&#x2F;enp7s0）设置成启用（否则网卡为Down状态，无法使用）。</p><p>OpenWrt三网口，管理口(eth0)，Hostonly，用于Host访问；WAN口(eth1)，桥接物理网口，连接ISP网口；LAN口(eth2)，桥接物理网口，连接交换机。大致示意图可参照<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/virtualization/virtualbox-advanced">OpenWrt说明</a></p><p><img data-src="https://openwrt.org/_media/media/netdiag1c.png?w=600&tok=ebf41f" alt="Networking Example"></p><h2 id="安装Virtual-Box"><a href="#安装Virtual-Box" class="headerlink" title="安装Virtual Box"></a>安装Virtual Box</h2><p><a target="_blank" rel="noopener" href="https://www.virtualbox.org/wiki/Linux_Downloads">官方文档</a>安装VirtualBox和Extension Pack，另外需要安装编译工具和对应头文件，<code>dkms,build-essential, linux-headers-$(uname -r)</code>，将用户加入用户组<code>usermod -a -G vboxusers user</code>。</p><p>有一点就是如果内核有升级的话，VirtualBox就需要重新设置下<code>/usr/sbin/vboxconfig</code>，所以非必要情况下不升级内核，<code>apt-mark hold linux-image-amd64 linux-headers-$(uname -r)</code>。</p><p>安装Extension Pack，<code>VBoxManage extpack install ext.vbox-extpack</code></p><p>检查服务<code>vboxautostart-service</code>是否自动启动，这样Host启动时，会自动启动对应的vm。</p><h2 id="安装OpenWrt"><a href="#安装OpenWrt" class="headerlink" title="安装OpenWrt"></a>安装OpenWrt</h2><p>下载对应<a target="_blank" rel="noopener" href="https://downloads.openwrt.org/releases/19.07.8/targets/x86/64/openwrt-19.07.8-x86-64-combined-ext4.img.gz">OpenWrt镜像</a>，参考<a target="_blank" rel="noopener" href="https://downloads.openwrt.org/">官方地址</a></p><h3 id="创建vm"><a href="#创建vm" class="headerlink" title="创建vm"></a>创建vm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/vbox</span><br><span class="line"><span class="built_in">cd</span> ~/vbox</span><br><span class="line">VBoxManage createvm openwrt --ostype Linux26_64 --registervm --default --basepath `<span class="built_in">pwd</span>`</span><br><span class="line"><span class="built_in">cd</span> ~/vbox/openwrt</span><br><span class="line">wget -c https://downloads.openwrt.org/releases/19.07.8/targets/x86/64/openwrt-19.07.8-x86-64-combined-ext4.img.gz</span><br><span class="line">gzip -d openwrt-*x86-64-combined*.img.gz</span><br><span class="line">VBoxManage convertfromraw --format VDI openwrt-*x86-64-combined*.img openwrt.vdi</span><br></pre></td></tr></table></figure><p>VirtualBox创建一个Linux vm，设置基础目录为<code>~/vbox/openwrt</code>，下载对应镜像，并转换为VirtualBox可用的文件。</p><h3 id="修改vm配置"><a href="#修改vm配置" class="headerlink" title="修改vm配置"></a>修改vm配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage hostonlyif create</span><br><span class="line">VBoxManage hostonlyif ipconfig vboxnet0</span><br><span class="line">VBoxManage hostonlyif ipconfig vboxnet0 --ip 192.168.56.1 --netmask 255.255.255.0</span><br><span class="line">VBoxManage dhcpserver add --network=vboxnet0 --server-ip=192.168.56.1 --lower-ip=192.168.56.101 --upper-ip=192.168.56.254 --etmask=255.255.255.0 --<span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">VBoxManage modifyvm openwrt --memory 128 --boot1 disk --boot2 none --boot3 none --nic1 hostonly --nictype1 virtio --hostonlyadapter1 vboxnet0 --nic2 bridged --nictype2 virtio --bridgeadapter2 enp6s0 --nic3 bridged --nictype3 virtio --bridgeadapter3 enp1s0 --mouse ps2 --keyboard ps2 --audio none --usb off --usbehci off --usbxhci off --vrde on --vrdeport 10001 --audostart-enabled of --autostart-delay 120</span><br></pre></td></tr></table></figure><p>这里主要是创建一个hostonly网络，并设置好IP，DHCP等，Host的IP是192.168.56.1，等下Openwrt里面再设置管理口的IP。然后修改openwrt vm的内存为128，只从硬盘启动，网卡1为hostonly管理网卡，网卡2为bridged的WAN(enp6s0)口，网卡3为bridged的LAN(enp1s0)口。然后关闭声卡，USB。</p><p><a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch08.html">VBoxManage Manual</a></p><h3 id="挂载OpenWrt镜像"><a href="#挂载OpenWrt镜像" class="headerlink" title="挂载OpenWrt镜像"></a>挂载OpenWrt镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage showvminfo openwrt | grep <span class="string">&#x27;Storage Controller&#x27;</span></span><br><span class="line">VBoxManage storageatt openwrt --storagectl <span class="string">&#x27;SATA&#x27;</span> --device 0 --port 0 --<span class="built_in">type</span> hdd --medium ~/vbox/openwrt/openwrt.vdi</span><br></pre></td></tr></table></figure><p>正常默认情况下有个IDE和SATA，IDE用于光驱，SATA用于硬盘使用。然后将openwrt的镜像挂载为硬盘。</p><h3 id="虚拟机随host自动启动"><a href="#虚拟机随host自动启动" class="headerlink" title="虚拟机随host自动启动"></a>虚拟机随host自动启动</h3><p>参考<a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch09.html#autostart">Manual</a>,<a target="_blank" rel="noopener" href="https://kifarunix.com/autostart-virtualbox-vms-on-system-boot-on-linux/">AutoStart VirtualBox VMs on System Boot on Linux</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage modifyvm openwrt --autostart-enabled on --autostart-delay 10</span><br></pre></td></tr></table></figure><h3 id="远程控制vrde"><a href="#远程控制vrde" class="headerlink" title="远程控制vrde"></a>远程控制vrde</h3><p>参考<a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch08.html#vboxmanage-modifyvm-vrde">Manual</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage modifyvm openwrt --vrde on --vrde-port 10001</span><br></pre></td></tr></table></figure><p>这样就可以通过Host OS的<code>10001</code>端口进行远程操作，直接使用windows的mstsc可以连接，linux的rdesktop。</p><h2 id="OpenWrt网络配置"><a href="#OpenWrt网络配置" class="headerlink" title="OpenWrt网络配置"></a>OpenWrt网络配置</h2><p>前面配置好OpenWrt后，先将网卡设置成断开，然后启动OpenWrt，防止网络冲突啥的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage controlvm openwrt poweroff</span><br><span class="line">VBoxManage modifyvm openwrt --cableconnected1 off --cableconnected2 off --cableconnected3 off</span><br><span class="line">VBoxManage startvm --<span class="built_in">type</span> headless</span><br></pre></td></tr></table></figure><p>然后远程连上10001端口进行网络设置，将三张网卡分别设置好。</p><figure class="highlight plaintext"><figcaption><span>/etc/config/network</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">config interface &#x27;loopback&#x27;</span><br><span class="line">        option ifname &#x27;lo&#x27;</span><br><span class="line">        option proto &#x27;static&#x27;</span><br><span class="line">        option ipaddr &#x27;127.0.0.1&#x27;</span><br><span class="line">        option netmask &#x27;255.0.0.0&#x27;</span><br><span class="line"></span><br><span class="line">config globals &#x27;globals&#x27;</span><br><span class="line"></span><br><span class="line">config interface &#x27;lan&#x27;</span><br><span class="line">        option ifname &#x27;eth2&#x27;</span><br><span class="line">        option proto &#x27;static&#x27;</span><br><span class="line">        option netmask &#x27;255.255.255.0&#x27;</span><br><span class="line">        option ip6assign &#x27;60&#x27;</span><br><span class="line">        option ipaddr &#x27;192.168.1.1&#x27;</span><br><span class="line"></span><br><span class="line">config interface &#x27;wan&#x27;</span><br><span class="line">        option ifname &#x27;eth1&#x27;</span><br><span class="line">        option proto &#x27;pppoe&#x27;</span><br><span class="line">        option password &#x27;password&#x27;</span><br><span class="line">        option ipv6 &#x27;auto&#x27;</span><br><span class="line">        option username &#x27;username&#x27;</span><br><span class="line"></span><br><span class="line">config interface &#x27;mng&#x27;</span><br><span class="line">        option proto &#x27;static&#x27;</span><br><span class="line">        option netmask &#x27;255.255.255.0&#x27;</span><br><span class="line">        option ifname &#x27;eth0&#x27;</span><br><span class="line">        option ipaddr &#x27;192.168.56.2&#x27;</span><br></pre></td></tr></table></figure><p>配置DHCP，主要是为了使用IPv6，见lan配置处。</p><figure class="highlight plaintext"><figcaption><span>/etc/config/dhcp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">config dnsmasq</span><br><span class="line">        option domainneeded &#x27;1&#x27;</span><br><span class="line">        option localise_queries &#x27;1&#x27;</span><br><span class="line">        option rebind_protection &#x27;1&#x27;</span><br><span class="line">        option rebind_localhost &#x27;1&#x27;</span><br><span class="line">        option local &#x27;/lan/&#x27;</span><br><span class="line">        option domain &#x27;lan&#x27;</span><br><span class="line">        option expandhosts &#x27;1&#x27;</span><br><span class="line">        option authoritative &#x27;1&#x27;</span><br><span class="line">        option readethers &#x27;1&#x27;</span><br><span class="line">        option leasefile &#x27;/tmp/dhcp.leases&#x27;</span><br><span class="line">        option resolvfile &#x27;/tmp/resolv.conf.auto&#x27;</span><br><span class="line">        option localservice &#x27;1&#x27;</span><br><span class="line">        option confdir &#x27;/tmp/dnsmasq.d&#x27;</span><br><span class="line"></span><br><span class="line">config dhcp &#x27;lan&#x27;</span><br><span class="line">        option interface &#x27;lan&#x27;</span><br><span class="line">        option start &#x27;100&#x27;</span><br><span class="line">        option limit &#x27;150&#x27;</span><br><span class="line">        option leasetime &#x27;12h&#x27;</span><br><span class="line">        option ra_management &#x27;1&#x27;</span><br><span class="line">        option ra &#x27;server&#x27;</span><br><span class="line">        option dhcpv6 &#x27;server&#x27;</span><br><span class="line">        option ndp &#x27;relay&#x27;</span><br><span class="line"></span><br><span class="line">config dhcp &#x27;wan&#x27;</span><br><span class="line">        option interface &#x27;wan&#x27;</span><br><span class="line">        option ignore &#x27;1&#x27;</span><br></pre></td></tr></table></figure><p>取消ipv6防火墙，禁止LAN口上网，需要授权才能使用。见<a href="/2019/04/05/openwrt-restricting-internet-access-based-on-mac-address/">OpenWrt限制设备连接Internet</a>。如没有此需求，将forwarding段的enabled选项设置为1即可。</p><figure class="highlight plaintext"><figcaption><span>/etc/config/firewall</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">config defaults</span><br><span class="line">        option syn_flood &#x27;1&#x27;</span><br><span class="line">        option input &#x27;ACCEPT&#x27;</span><br><span class="line">        option output &#x27;ACCEPT&#x27;</span><br><span class="line">        option forward &#x27;REJECT&#x27;</span><br><span class="line">        option disable_ipv6 &#x27;1&#x27;</span><br><span class="line">        option drop_invalid &#x27;1&#x27;</span><br><span class="line"></span><br><span class="line">config zone</span><br><span class="line">        option name &#x27;lan&#x27;</span><br><span class="line">        option input &#x27;ACCEPT&#x27;</span><br><span class="line">        option output &#x27;ACCEPT&#x27;</span><br><span class="line">        option forward &#x27;ACCEPT&#x27;</span><br><span class="line">        list network &#x27;lan&#x27;</span><br><span class="line"></span><br><span class="line">config zone</span><br><span class="line">        option name &#x27;wan&#x27;</span><br><span class="line">        option input &#x27;REJECT&#x27;</span><br><span class="line">        option output &#x27;ACCEPT&#x27;</span><br><span class="line">        option forward &#x27;REJECT&#x27;</span><br><span class="line">        option masq &#x27;1&#x27;</span><br><span class="line">        option mtu_fix &#x27;1&#x27;</span><br><span class="line">        list network &#x27;wan&#x27;</span><br><span class="line"></span><br><span class="line">config forwarding</span><br><span class="line">        option src &#x27;lan&#x27;</span><br><span class="line">        option dest &#x27;wan&#x27;</span><br><span class="line">        option enabled &#x27;0&#x27;</span><br></pre></td></tr></table></figure><p>一切就绪后就可以将网卡连接上使用了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage controlvm openwrt poweroff</span><br><span class="line">VBoxManage modifyvm openwrt --cableconnected1 on --cableconnected2 on --cableconnected3 on</span><br><span class="line">VBoxManage startvm --<span class="built_in">type</span> headless</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2019/11/02/k8s-installation/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2019/11/02/k8s-installation/" class="post-title-link" itemprop="url">kubernetes及Gitlab-Runner安装</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-11-02 02:58:49" itemprop="dateCreated datePublished" datetime="2019-11-02T02:58:49+08:00">2019-11-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>团队去年将代码管理迁移到Gitlab后，尝试了CI&#x2F;CD，用Gitlab-Runner来测试提交的代码是否有问题，用3台机器，kubeadm搭建了一个小的k8s运行环境。上个月25日突然反映runner不能正常运行，后台看了下是证书过期的原因，kubeadm v1.5后好像有证书更新的功能，之前用的好像是v1.2版本，证书更新起来不太方便。现在在做项目，没有时间去整理，还不如重新搭建算了。后来有时间的话，再尝试搭建k8s，the hard way，应该会对kubernetes更深一步的了解。</p><p>前段时间CentOS 8发布了，也试了下CentOS 8，但是各方软件兼容还存在一点问题，比如Docker，后来还是以CentOS 7为操作系统。vSphere里新建一台机器，各参数设置好后，再Clone两台，修改IP和hostname就OK，省一些系统安装的时间。</p><h2 id="Docker准备"><a href="#Docker准备" class="headerlink" title="Docker准备"></a>Docker准备</h2><p>Docker安装比较简单，按<a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/centos/">官方指引</a>来就OK，因其它原因国内下载Docker Image比较慢，需要一些简单配置，主要参考<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/">TUNA</a>和<a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/help/dockerhub.html">USTC</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">sudo sed -i <span class="string">&#x27;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum install yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum install docker-ce</span><br><span class="line">gpasswd -a user docker</span><br><span class="line">systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>/etc/docker/daemon.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">,</span><span class="string">&quot;https://docker.mirrors.ustc.edu.cn/&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.17.65.22:8088&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="string">&quot;production_status&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;os,customer&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Kubeadm安装k8s"><a href="#Kubeadm安装k8s" class="headerlink" title="Kubeadm安装k8s"></a>Kubeadm安装k8s</h2><h3 id="Kubeadm准备"><a href="#Kubeadm准备" class="headerlink" title="Kubeadm准备"></a>Kubeadm准备</h3><p>Kubeadm安装参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">官方文档</a>。这次安装的版本是v1.16.2，版本不一样可能涉及到一些Docker Image不一样。可通过<code>kubeadm config images list</code>查看对应版本需要下载的镜像。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">#gpgcheck=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set SELinux in permissive mode (effectively disabling it)</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;  /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h3 id="Docker-Image准备"><a href="#Docker-Image准备" class="headerlink" title="Docker Image准备"></a>Docker Image准备</h3><p>因为某些原因无法从外网下载镜像，需要手动处理下，这里要感谢下阿里，提供了一个镜像下载地址。</p><figure class="highlight bash"><figcaption><span>./k8s_mirror.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">images=(kube-apiserver:v1.16.2</span><br><span class="line">kube-controller-manager:v1.16.2</span><br><span class="line">kube-scheduler:v1.16.2</span><br><span class="line">kube-proxy:v1.16.2</span><br><span class="line">pause:3.1</span><br><span class="line">etcd:3.3.15-0</span><br><span class="line">coredns:1.6.2)</span><br><span class="line"><span class="comment">#flannel:v0.11.0-amd64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or bluersw/image:version</span></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line"><span class="comment">#docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName 10.17.65.22:8088/$imageName</span></span><br><span class="line"><span class="comment">#docker push 10.17.65.22:8088/$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>写好脚本后，直接运行这个脚本，把需要的Image拉下来。</p><h3 id="k8s节点"><a href="#k8s节点" class="headerlink" title="k8s节点"></a>k8s节点</h3><p>k8s的节点安装参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">官方文档</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --kubernetes-version=v1.16.2 --apiserver-advertise-address=10.17.65.250 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.1.0.0/16</span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf ~/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> liangwu:liangwu ~/.kube/config</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>其它节点根据<code>kubeadm init</code>后的提示直接<code>kubeadm join</code>就好了。<a target="_blank" rel="noopener" href="https://github.com/sunweisheng/Kubernetes/blob/master/Install.md">前提也是需要把一些镜像拉下来</a>。</p><ul><li>k8s.gcr.io&#x2F;pause:3.1</li><li>k8s.gcr.io&#x2F;kube-proxy:v1.16.2</li><li>quay.io&#x2F;coreos&#x2F;flannel:v0.11.0-amd64</li></ul><h2 id="Gitlab-Runner-Helm安装"><a href="#Gitlab-Runner-Helm安装" class="headerlink" title="Gitlab-Runner Helm安装"></a>Gitlab-Runner Helm安装</h2><h3 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h3><p>参照<a target="_blank" rel="noopener" href="https://helm.sh/docs/using_helm/#installing-helm">官方文档</a>，作简要配置。</p><figure class="highlight yaml"><figcaption><span>rbac-config.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><p>然后运行<code>kubectl create -f rbac-config.yaml</code>。或者其它方式。主要是<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/admin/authorization/rbac/#service-account-permissions">RBAC</a>的问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccount&quot;:&quot;tiller&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Helm配置"><a href="#Helm配置" class="headerlink" title="Helm配置"></a>Helm配置</h3><p>Helm也涉及到一些被墙的东西，换下拉取地址。再次感谢阿里？ :)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add gitlab https://charts.gitlab.io/</span><br><span class="line">helm init -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.5.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts --service-account tiller --history-max 200</span><br></pre></td></tr></table></figure><h3 id="Gitlab-Runner安装"><a href="#Gitlab-Runner安装" class="headerlink" title="Gitlab Runner安装"></a>Gitlab Runner安装</h3><p>Gitlab Runner的<a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/kubernetes.html">文档</a>确实好像不怎么样，好多东西都没写，或者写得不好。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values.yaml需要根据自己实际情况进行修改，各项都有说明</span></span><br><span class="line">wget -c https://gitlab.com/gitlab-org/charts/gitlab-runner/raw/master/values.yaml?inline=<span class="literal">false</span></span><br><span class="line">helm fetch gitlab/gitlab-runner</span><br><span class="line">tar xvf gitlab-runner-<span class="variable">$&#123;version&#125;</span>.tgz</span><br><span class="line">helm install --namespace gitlab --name gitlab-runner -f values.yaml ./gitlab-runner-<span class="variable">$&#123;version&#125;</span></span><br></pre></td></tr></table></figure><p><code>values.yaml</code>有以下几点需要注意的。</p><figure class="highlight yaml"><figcaption><span>values.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">gitlabUrl:</span> <span class="string">&quot;http://10.17.65.22:5622/gitlab&quot;</span></span><br><span class="line"><span class="comment">#注册新runner</span></span><br><span class="line"><span class="attr">runnerRegistrationToken:</span> <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="comment">#已有runner的token</span></span><br><span class="line"><span class="attr">runnerToken:</span> <span class="string">&quot;D1zsss2nS6Lgkx5M4_zx&quot;</span></span><br><span class="line"><span class="attr">runners:</span></span><br><span class="line">  <span class="comment">#从私有docker registry中拉取image时需要的认证信息，可参考原values.yaml中的k8s官方链接说明</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> [<span class="string">&quot;regcred&quot;</span>]</span><br></pre></td></tr></table></figure><p>我们Gitlab CI&#x2F;CD中有个验证就是利用maven编译代码是否可通过，其中需要拉取很多供事的jar包，每次都拉取比较耗时，虽然都从局域网的私服拉。可将.m2的缓存存在node本机，小的k8s就这么做吧。懒得去设置PV，PVC了。以后需要大的k8s，再去整PV吧。NFS啊，MinIO之类的。在helm包文件里修改<code>templates/configmap.yaml</code>，在<code>start gitlab runner</code>之前加入以下内容。已经在<a target="_blank" rel="noopener" href="https://gist.github.com/glw119/12b670537893e91068981ce05a9e0e5e#file-configmap-yaml-L45-L54">Gist</a>中加入。</p><figure class="highlight yaml"><figcaption><span>gitlab-runner/templates/configmap.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### ...</span></span><br><span class="line"></span><br><span class="line">    <span class="string">cat</span> <span class="string">&gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line">            [[<span class="string">runners.kubernetes.volumes.host_path</span>]]</span><br><span class="line">              <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;m2&quot;</span></span><br><span class="line">              <span class="string">mount_path</span> <span class="string">=</span> <span class="string">&quot;/root/.m2&quot;</span></span><br><span class="line">              <span class="string">host_path</span> <span class="string">=</span> <span class="string">&quot;/m2&quot;</span></span><br><span class="line">            [[<span class="string">runners.kubernetes.volumes.host_path</span>]]</span><br><span class="line">              <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;cache&quot;</span></span><br><span class="line">              <span class="string">mount_path</span> <span class="string">=</span> <span class="string">&quot;/cache&quot;</span></span><br><span class="line">              <span class="string">host_path</span> <span class="string">=</span> <span class="string">&quot;/cache&quot;</span></span><br><span class="line">    <span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### ...</span></span><br></pre></td></tr></table></figure><p>下面是配置文件详情。</p><script src="//gist.github.com/12b670537893e91068981ce05a9e0e5e.js?file=configmap.yaml"></script><script src="//gist.github.com/12b670537893e91068981ce05a9e0e5e.js?file=values.yaml"></script></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Liangwu</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a></div></div></footer><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script></body></html>