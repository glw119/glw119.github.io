<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="manifest" href="/manifest.json"><meta name="google-site-verification" content="Ke_HLBE1VTaPAM92Uvmu83gGuH28rv4bw7lfrfr2Fc8"><meta name="msvalidate.01" content="E071B510B0369A55948886E7534E0B0C"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"notes.guoliangwu.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="NAS搭建其实很早的时候就想搞一台NAS玩了，毕竟有很多想收藏的高清视频，还有一些自己私人资料，不方便存在云盘里面的。之前HP Gen8机器还是不错，扩展性也非常不错，只是感觉有点小贵，然后就是风扇噪音问题比较严重，查了下说是HP虚拟的一个Raid卡造成的问题，在*nix下面无法获取到硬盘的温度，导致风扇会以最大转速工作。当然查Gen8的资料是最近正式想整一台NAS后才开始。之前是用蛮早的一台上网"><meta property="og:type" content="blog"><meta property="og:title" content="NAS搭建"><meta property="og:url" content="https://notes.guoliangwu.com/2019/03/22/nas-setting-up/index.html"><meta property="og:site_name" content="Liangwu&#39;s Notes"><meta property="og:description" content="NAS搭建其实很早的时候就想搞一台NAS玩了，毕竟有很多想收藏的高清视频，还有一些自己私人资料，不方便存在云盘里面的。之前HP Gen8机器还是不错，扩展性也非常不错，只是感觉有点小贵，然后就是风扇噪音问题比较严重，查了下说是HP虚拟的一个Raid卡造成的问题，在*nix下面无法获取到硬盘的温度，导致风扇会以最大转速工作。当然查Gen8的资料是最近正式想整一台NAS后才开始。之前是用蛮早的一台上网"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2019-03-22T00:50:16.000Z"><meta property="article:modified_time" content="2023-05-12T13:48:44.626Z"><meta property="article:author" content="Liangwu"><meta property="article:tag" content="SSH"><meta property="article:tag" content="Debian"><meta property="article:tag" content="NAS"><meta property="article:tag" content="J3455"><meta property="article:tag" content="NextCloud"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://notes.guoliangwu.com/2019/03/22/nas-setting-up/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://notes.guoliangwu.com/2019/03/22/nas-setting-up/","path":"2019/03/22/nas-setting-up/","title":"NAS搭建"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>NAS搭建 | Liangwu's Notes</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Liangwu's Notes</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Just note anything</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#NAS%E6%90%AD%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">NAS搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="nav-number">1.1.</span> <span class="nav-text">技术选型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FreeBSD-x2F-ZFS-x2F-Jail"><span class="nav-number">1.1.1.</span> <span class="nav-text">FreeBSD&#x2F;ZFS&#x2F;Jail</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenMediaVault-OMV"><span class="nav-number">1.1.2.</span> <span class="nav-text">OpenMediaVault(OMV)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debian-x2F-LVM-x2F-Docker"><span class="nav-number">1.1.3.</span> <span class="nav-text">Debian&#x2F;LVM&#x2F;Docker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.</span> <span class="nav-text">硬件配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.</span> <span class="nav-text">软件配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Debian"><span class="nav-number">1.3.1.</span> <span class="nav-text">Debian</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVM"><span class="nav-number">1.3.2.</span> <span class="nav-text">LVM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PV%E6%93%8D%E4%BD%9C"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">PV操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VG%E6%93%8D%E4%BD%9C"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">VG操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LV%E6%93%8D%E4%BD%9C"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">LV操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sshd"><span class="nav-number">1.3.3.</span> <span class="nav-text">sshd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="nav-number">1.3.4.</span> <span class="nav-text">内网穿透</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7"><span class="nav-number">1.3.5.</span> <span class="nav-text">下载工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NextCloud"><span class="nav-number">1.3.6.</span> <span class="nav-text">NextCloud</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SAMBA"><span class="nav-number">1.3.7.</span> <span class="nav-text">SAMBA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NFS"><span class="nav-number">1.3.8.</span> <span class="nav-text">NFS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E5%AE%83"><span class="nav-number">1.3.9.</span> <span class="nav-text">其它</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BIOS%E8%AE%BE%E7%BD%AE"><span class="nav-number">1.4.</span> <span class="nav-text">BIOS设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tips"><span class="nav-number">1.5.</span> <span class="nav-text">tips</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.</span> <span class="nav-text">后期优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PXE"><span class="nav-number">1.6.1.</span> <span class="nav-text">PXE</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Liangwu" src="https://avatars.githubusercontent.com/u/1228007?v=4"><p class="site-author-name" itemprop="name">Liangwu</p><div class="site-description" itemprop="description">Idea, Action</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/glw119" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://weibo.com/glw119" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a> </span><span class="links-of-author-item"><a href="https://twitter.com/glw119" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2019/03/22/nas-setting-up/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="NAS搭建 | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">NAS搭建</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-03-22 08:50:16" itemprop="dateCreated datePublished" datetime="2019-03-22T08:50:16+08:00">2019-03-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="NAS搭建"><a href="#NAS搭建" class="headerlink" title="NAS搭建"></a>NAS搭建</h1><p>其实很早的时候就想搞一台NAS玩了，毕竟有很多想收藏的高清视频，还有一些自己私人资料，不方便存在云盘里面的。之前HP Gen8机器还是不错，扩展性也非常不错，只是感觉有点小贵，然后就是风扇噪音问题比较严重，查了下说是HP虚拟的一个Raid卡造成的问题，在*nix下面无法获取到硬盘的温度，导致风扇会以最大转速工作。当然查Gen8的资料是最近正式想整一台NAS后才开始。之前是用蛮早的一台上网本，好像是三星N2600之类的型号吧，装了CentOS，专门下载PT和存照片。后来空间不够用，就想起还是组一台NAS吧，正好家里有6台笔记本(Surface Pro 4, Thinkpad T400, Thinkpad E330, Thinkpad E420 x 2, Samung N2600)，2.5寸硬盘有6个，本着不能浪费的原则，就开始整NAS了。</p><h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>19年春节前就一直想着这个事情，老天也是“给力”，春节期间还真是没有出过一个太阳，就宅在家里想着怎么组这个NAS。</p><h3 id="FreeBSD-x2F-ZFS-x2F-Jail"><a href="#FreeBSD-x2F-ZFS-x2F-Jail" class="headerlink" title="FreeBSD&#x2F;ZFS&#x2F;Jail"></a>FreeBSD&#x2F;ZFS&#x2F;Jail</h3><p>FreeBSD很稳定，port也非常好用。之前工作的主力系统是Gentoo，所以对FreeBSD很有好感。但是ZFS一直没有正式接触过，于是把<a target="_blank" rel="noopener" href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/">FreeBSD Handbook</a>好好地看了下，确实ZFS很强大，可以忘掉Raid，忘掉分区，不同目录设置不能参数适应不同用途（加密，压缩等等），快照功能。还有Jail可用，用途有点类似Linux下的Docker，可以把程序关到Jail里运行，不影响主系统。</p><p>但是真正用起来感觉还有好多东西需要深入研究，但又没那么多时间。</p><ol><li>ZFS很强大，但同时也是内存大户，推荐是1T配1G内存，然后建议是配ECC内存（这个作者原意思是关心数据的话，不管是什么文件系统，都建议ECC）。现在内存不是太贵，但是要自己组NAS的话，ECC内存好像不好搞定。</li><li>ZFS优化比较麻烦。在虚拟机里用ZFS和UFS测试NextCloud&#x2F;MySQL时，发现ZFS明显慢很多。放狗搜了下，关于ZFS优化MySQL这方面，有蛮多参数需要配置的。</li><li>ZFS快照功能暂时好像用不上，没这需要。但蛮喜欢加密和压缩功能的。</li><li>Jail配置NAT网络比较麻烦，不如Docker来得方便。而且PF与iptables又不一样，还要查不少资料，烦。</li><li>担心FreeBSD的硬件兼容性，不能够让NAS达到最节能的状态。</li></ol><p>所以最后还是放弃了FreeBSD。</p><h3 id="OpenMediaVault-OMV"><a href="#OpenMediaVault-OMV" class="headerlink" title="OpenMediaVault(OMV)"></a>OpenMediaVault(OMV)</h3><p>之前本来确实是想用FreeBSD来组NAS的，后来@kurtyan推荐使用OMV。然后就是虚拟机里搞了一把，有几个槽点吧。</p><ol><li>OMV镜像安装不支持UEFI，这个锅应该让Debian 8背吧。。。然后就是OMV镜像安装时，好像要选整个硬盘，这个有点恶心，后来干脆自己先装好Debian 9然后再装OMV。</li><li>感觉Web管理页面上有太多我不想要，也用不着的功能，看着比较浪费。</li></ol><p>感觉OMV比较适合新手，界面什么的还是比较友好的。后来一想这个web管理界面，FreeBSD的webadmin也可以管理啊，一查Linux也可以用webadmin。但最后还是没有用webadmin，自己从基层组算了。</p><h3 id="Debian-x2F-LVM-x2F-Docker"><a href="#Debian-x2F-LVM-x2F-Docker" class="headerlink" title="Debian&#x2F;LVM&#x2F;Docker"></a>Debian&#x2F;LVM&#x2F;Docker</h3><p>OMV是基于Debian的，还不如自己搭建想要的功能呢。刚开始有考虑CentOS，但本人不喜欢它的图形安装界面，好像比Debian耗资源一些，就pass掉了。</p><p>既然是自己用的NAS就需要考虑下数据的安全问题，以防硬盘突然挂掉，开始考虑的是软raid，重要数据raid 1，视频数据raid 0，后来考虑再三还是放弃了软raid的方案，买的是4盘位机箱，比较少，还是用USB3.0外挂硬盘，定时备份重要数据，特别重要的文件就GnuPG加密后传网盘。还有一个就是使用LVM管理分区，这样可以最大限度地使用硬盘空间，后面系统配置的时候再详细谈下。其实ZFS对于这两点很适合，send&#x2F;recv备份很方便，分区根本不需要管，把不同硬盘加到不同pool就OK了。</p><p>还有一个选Linux的原因应该就是Docker了。这样可以很大程序减少应用程序对系统的干扰，把能在Docker下面跑的都放进去，各自跑各自的。</p><p>所以我最后选择了Debian开干。</p><h2 id="硬件配置"><a href="#硬件配置" class="headerlink" title="硬件配置"></a>硬件配置</h2><p>硬件配置最开始设想的是4个SATA3接口，2个网卡，PICe接口进行扩展，CPU性能无所谓。网上搜了不少，候选方案有下面几个：</p><ol><li>HP Gen8。2个数据网口，1个管理网口。这点对于服务器管理非常重要，丢在某个角落完全不用管，可直接iLO进行所有操作。有4个盘位，还有内置的USB、SD卡插口。就是有点小贵，还有风扇噪音。</li><li>HP Gen10。2个数据网口，4个盘位，AMD CPU。感觉也OK，风扇不吵了，但是少了iLO，而且低配价格也很高。</li><li>GA N3160主板。2个数据网口，4个盘位，PCI插槽。刚开始是冲是它去的，最后PCI插槽放弃了，而且价格比J3455贵100多大洋。</li><li>ASRock J4105&#x2F;J3455。1个数据网口，4个盘位，PCIe x1插槽。两块板CPU有差别，内存一个是DDR4，一个是DDR3。但是J3455支持16G，J4105只支持8G。最后选择了J3455，因为它便宜 :)</li></ol><p>其实最早是蛮想2个网口链路聚合的，这样多处同时从NAS存取数据的时候，网络不会成为其瓶颈，后来想了想，估计同时多处使用NAS的情况最近几年都不会有，后面如果确实有需要，可以PCIe转双网卡就OK。家里网线是六类双屏蔽（那个硬啊，现在有点后悔用双屏蔽的了），交换机Linksys SLM2008，路由器Buffalo WZR-HP-AG300H，光纤入户100M，所以暂时屋内1G局域网应该够用了。</p><p>这里给自己上了一课吧，当时查ASRock官网J3455的时候，就注意到SATA的第3，4接口是ASMedia ASM1061出来的，跟我后来买的PCIe转SATA接口是一样的。好像最高是400MB&#x2F;s，就是如果这几个接口上SSD的话，可能会影响期性能。而且PCIe 2.0 x1的最高速度是500MB&#x2F;s，这块也成了影响其性能的要点了。</p><p>电源选择方面，可以选小的DC转24针这种，完全没有噪音，功耗也低，但是但是贵啊。。。。最后选了一个ENP 7025B 250W的Flex电源，有噪音，功耗也比DC高，但是但是便宜啊 :(</p><p>开始机箱自带的风扇是12cm，直接从电源取电，也就是说一直是全速状态。看了下J3455板是CPU和机箱风扇电源接口都是3线的，所以可以调节风扇转速，后来又购了1个12cm 1500rpm的3线风扇。可惜板子不支持4线的风扇。。。</p><p>嗯，后面再详细记录下系统方面的配置吧。</p><h2 id="软件配置"><a href="#软件配置" class="headerlink" title="软件配置"></a>软件配置</h2><h3 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h3><p>Debian安装比较简单了，将网络安装的ISO写入到U盘，安装就OK了。其实完全可以用PXE来搞定，后面再记录下PXE吧。</p><h3 id="LVM"><a href="#LVM" class="headerlink" title="LVM"></a>LVM</h3><p>LVM里面有几个名词，PV物理卷（可以是硬盘，分区，文件），VG卷组（由物理卷组成的组，有点类似ZFS的Pool），LV逻辑卷（类似普通分区，可格式化，挂载）。</p><h4 id="PV操作"><a href="#PV操作" class="headerlink" title="PV操作"></a>PV操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/xxx bs=512 count=1</span><br><span class="line">pvcreate /dev/xxx</span><br><span class="line">pvs</span><br><span class="line">pvremove /dev/xxx</span><br></pre></td></tr></table></figure><h4 id="VG操作"><a href="#VG操作" class="headerlink" title="VG操作"></a>VG操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vgcreate vg-nas /dev/xxx /dev/xxx</span><br><span class="line">vgextend vg-nas /dev/xxx</span><br><span class="line">vgreduce vg-nas /dev/xxx</span><br><span class="line">vgchange -a y/n vg-nas <span class="comment"># activating/deactivating vg</span></span><br><span class="line">vgremove vg-nas</span><br><span class="line">vgrename vg-nas-old vg-nas-new</span><br><span class="line">vgs</span><br></pre></td></tr></table></figure><h4 id="LV操作"><a href="#LV操作" class="headerlink" title="LV操作"></a>LV操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 1T -n lv-data vg-nas <span class="comment"># linar</span></span><br><span class="line">lvcreate -l 100%FREE -n lv-other vg-nas</span><br><span class="line">lvs</span><br><span class="line">lvextend -l +100%FREE -n vg-name lv-name <span class="comment"># /dev/vg-name/lv-name</span></span><br><span class="line">resize2fs /dev/vg-name/lv-name</span><br><span class="line">lvreduce --resizefs -L 500G vg-name/lv-name</span><br></pre></td></tr></table></figure><p>LVM调整挂载点容量大小就比较方便了，不明白的时候可以看RedHat的在线文档，写得很详细。</p><h3 id="sshd"><a href="#sshd" class="headerlink" title="sshd"></a>sshd</h3><p>默认SSHD是密码登录的，可以用<code>sshkey-gen</code>生成密钥后，再用<code>ssh-copy-id</code>将公钥复制到远程主机。NAS我需要internet也能访问到，这样SSHD默认配置就不太合适了，需要改几个地方，其实打开<code>/etc/ssh/sshd_config</code>就一目了然，从配置字面上就能知道啥作用了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Protocol 2</span><br><span class="line"></span><br><span class="line">PermitRootLogin no</span><br><span class="line">StrictModes yes</span><br><span class="line">MaxAuthTries 6 #BAN IP的话可以用Fail2ban</span><br><span class="line">MaxSessions 10</span><br><span class="line"></span><br><span class="line">AuthorizedKeysCommand none</span><br><span class="line">AuthorizedKeysCommandUser nobody</span><br><span class="line"></span><br><span class="line">PasswordAuthentication no</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line"></span><br><span class="line">AllowGroups sshusers #将需要使用ssh的用户加入sshusers用户组</span><br></pre></td></tr></table></figure><h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><p>之前内网穿透使用的是<a href="https://notes.guoliangwu.com/2018/11/18/use-ssh-proxy/">ssh端口转发</a>，NAS用远程端口转发<code>-R 2222:127.0.0.1:22 VPS</code>(VPS的2222端口转发到NAS的22端口)，然后在终端机使用本地端口转发<code>-L 4444:127.0.0.1:2222 VPS</code>(终端机4444端口转发到VPS的2222端口)，这样在终端机<code>ssh -p 4444 localhost</code>就可以访问NAS了，很方便不是？后来好像有时候网络不稳定，掉线后NAS不会自己进行端口转发，然后就找到了现在用的<a href="https://notes.guoliangwu.com/2018/11/18/use-ssh-proxy/">frp</a>和<a target="_blank" rel="noopener" href="https://github.com/kuoruan/openwrt-frp">openwrt frp</a>。</p><p>其中frp VPS Server端的配置如下。其实程序自带的说明文件里说得很详细，认真看下就可以配得很好了。</p><figure class="highlight ini"><figcaption><span>/etc/frp/frps.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bind_udp_port</span> = <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tcp_bind_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dashboard_addr</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dashboard_user</span> = user</span><br><span class="line"><span class="attr">dashboard_pwd</span> = pwd</span><br><span class="line"></span><br><span class="line"><span class="attr">log_file</span> = /var/log/frps.log</span><br><span class="line"></span><br><span class="line"><span class="attr">log_info</span> = info</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">privilege_token</span> = privilege_token</span><br><span class="line"></span><br><span class="line"><span class="attr">max_pool_count</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">max_ports_per_client</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">authentication_timeout</span> = <span class="number">900</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><figcaption><span>frps.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=frps daemon</span><br><span class="line">After=network.target</span><br><span class="line">Wants=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">ExecStart=/usr/bin/frps -c /etc/frp/frps.ini</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.targe</span><br></pre></td></tr></table></figure><p>其中NAS的frp配置如下。OpenWrt的话，直接使用screen，<code>sleep 30 &amp;&amp; screen -dmS frpc frpc -c /etc/frp/frpc.ini</code>，加到<code>/etc/rc.local</code>。</p><figure class="highlight ini"><figcaption><span>frpc.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = VPS_IP</span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log_file</span> = /var/log/frpc.log</span><br><span class="line"><span class="attr">log_level</span> = info</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">privilege_token</span> = privilege_token</span><br><span class="line"></span><br><span class="line"><span class="attr">admin_addr</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">admin_port</span> = <span class="number">7400</span></span><br><span class="line"><span class="attr">admin_user</span> = admin_user</span><br><span class="line"><span class="attr">admin_passwd</span> = admin_pwd</span><br><span class="line"></span><br><span class="line"><span class="attr">pool_count</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">user</span> = nas</span><br><span class="line"><span class="attr">log_fail_exit</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">protocol</span> = tcp</span><br><span class="line"></span><br><span class="line"><span class="section">[ssh]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">2222</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><figcaption><span>frpc.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=FRP Client Daemon</span><br><span class="line">After=network.target</span><br><span class="line">Wants=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/frpc -c /etc/frp/frpc.ini</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=20s</span><br><span class="line">User=nobody</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="下载工具"><a href="#下载工具" class="headerlink" title="下载工具"></a>下载工具</h3><p>NAS的话必须要下载片子咯，BT&#x2F;PT使用的是transmission，普通其它下载用的是aria2。使用transmission需要下载几个包<code>apt install transmission-&#123;daemon, remote&#123;,-cli&#125;&#125;</code>，平时使用的话我在bash里加了下载几个alias。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> lcp=<span class="string">&#x27;rsync -avhW --no-compress --progress&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> t-remote=<span class="string">&#x27;transmission-remote -n user:password localhost&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> t-remote=<span class="string">&#x27;transmission-remote-cli -c user:password@localhost:9091&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> a-d=<span class="string">&#x27;aria2c -x 10 -j 1 --http-user user --http-passwd passwd&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="NextCloud"><a href="#NextCloud" class="headerlink" title="NextCloud"></a>NextCloud</h3><p>其中架NAS最重要的一点就是网盘，放一些家庭照片和视频，常跟老婆説，等以后崽结婚的时候，把小时候的照片拿出来看，哈哈哈。</p><p>之前家里用的是FreeBSD下面架设的，这次换成Debian，那肯定就用Docker来跑这些咯，以后迁移起来也是非常快的，打包带走。。。</p><figure class="highlight yaml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=pwd1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=pwd2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=nextcloud</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=nextcloud</span></span><br><span class="line">  <span class="attr">nextcloud:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nextcloud:15-fpm-alpine</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./html:/var/www/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nextcloud</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./html:/var/www/html</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中<code>./nginx/default.conf</code>可以直接参考<a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/15/admin_manual/installation/nginx.html">官网文档</a>，然后还有一点就是nginx和nextcloud的docker image中用户名ID不一致，这样共享的目录<code>./html</code>就不能同时使用。需要调整下，nginx的image很小，可以直接从它下手，nginx的Dockerfile如下。</p><figure class="highlight dockerfile"><figcaption><span>nginx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/:100:/:82:/g&#x27;</span> /etc/passwd; \</span></span><br><span class="line"><span class="language-bash">    sed -i <span class="string">&#x27;s/:101:/:82:/g&#x27;</span> /etc/passwd /etc/group</span></span><br></pre></td></tr></table></figure><h3 id="SAMBA"><a href="#SAMBA" class="headerlink" title="SAMBA"></a>SAMBA</h3><p>家里其他设备访问NAS估计用得最多的就是SAMBA了吧，直接在<code>/etc/samba/smb.conf</code>最后加上一些配置就OK了，也懒得再认真配置了，只要能访问到就OK。</p><figure class="highlight plaintext"><figcaption><span>smb.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[public]</span><br><span class="line">  comment = public</span><br><span class="line">  path = /data/BTDownloads</span><br><span class="line">  browsable = yes</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = no</span><br><span class="line">  guest ok = yes</span><br><span class="line">[videos]</span><br><span class="line">  comment = public</span><br><span class="line">  path = /mnt/videos</span><br><span class="line">  browsable = yes</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = no</span><br><span class="line">  guest ok = yes</span><br><span class="line">[win7]</span><br><span class="line">  comment = public</span><br><span class="line">  path = /mnt/cdrom</span><br><span class="line">  browsable = no</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = no</span><br><span class="line">  guest ok = yes</span><br><span class="line">[personal]</span><br><span class="line">  comment = personal</span><br><span class="line">  path = /mnt/nas/personal</span><br><span class="line">  browsable = no</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = yes</span><br><span class="line">  guest ok = no</span><br></pre></td></tr></table></figure><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>家里还有一些其他设备，比如路由器(OpenWrt)和Raspberry Pi，它们可以很方便的使用NFS，这样NAS提供NFS服务就可以了。修改<code>/etc/exports</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/mnt/nas/Tools  *(no_subtree_check,ro,all_squash,insecure,async)</span><br></pre></td></tr></table></figure><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>硬盘多了，功率也大，安装包<code>hdparm</code>可以设置硬盘standby的时间，据説可以延长使用时间，减小功耗，前提是不要设置得太小，硬盘磁头一停一启动地可能更耗硬盘。修改<code>/etc/hdparm.conf</code></p><figure class="highlight plaintext"><figcaption><span>/etc/hdparm.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb &#123;</span><br><span class="line">    spindown_time = 250</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>安装<code>hddtemp sensors</code>来读取温度值。</p><h2 id="BIOS设置"><a href="#BIOS设置" class="headerlink" title="BIOS设置"></a>BIOS设置</h2><p>关闭非必要功能，节能设置等</p><p>WOL，需要开启PCIE power on</p><h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><ol><li><p>NAS下载了很多片片，要传到手机上看，之前都是iTunes通过WIFI读取SAMBA共享文件，再传到VLC，慢得1B，还得再多开台电脑。后来了解到可以直接用<code>curl</code>传，方便了很多。<code>curl -F &quot;filename=&#39;filename&#39;&quot; -F &quot;files[]=@filepath&quot; http://VLC_IP/upload.json</code>，本来想写个shell脚本自动上传目录下的所有文件的，但是没有找到好的方法，干脆用python吧，直接造成shell脚本运行。 :(不会直接使用Python上传到VLC，POST传的东西跟平时有点不一样。。。</p></li><li><p>下载Dropbox文件，Bash脚本<a target="_blank" rel="noopener" href="https://github.com/andreafabrizi/Dropbox-Uploader">Dropbox Uploader</a>，在VPS上面下载Dropbox的照片，然后再传回来。</p></li><li><p>下载OneDrive文件，用windows里面的客户端可能是最简单的，但没有在NAS里面安装虚拟机，也不想平时再开台机器。后来想了一条路，Chrome下载OneDrive的照片目录，zip文件，然后打开Chrome开发工具，直接将刚才那个请求<code>Copy as cURL</code>，这样可以直接在NAS下载照片了。</p></li><li><p>Picasaweb。long long ago，那时候Google还没有被封，传照片就到Picasa，哈哈，里面好多年轻的照片啊。这里需要设置下，在Google Drive里面设置下，将Google Photos照片导入到Google Drive，然后使用<code>rclone</code>将里面的照片复制到本地。<code>rclone copy remote:Google\ Photos /mnt/photos -P</code></p></li><li><p>照片存了这么多份，肯定有重复的。最开始写了脚本进行查重，思路就是找出所有图片文件，对md5码，发现效率不高，后来放狗搜发现一个好工具<code>fdepes</code>。<code>find . ! -empty -type f -size +500k -size -50M -exec md5sum &#123;&#125; + | sort &gt; ~/allfiles</code>，然后再对allfiles文件用unique就能找出重复文件了。<code>fdupes -r -S -1 Data Documents nextcloud Pictures Work &gt; ~/allfiles</code>，这个也是找出所有重复文件，还可以直接使用<code>fdupes</code>快速删除重复文件。</p></li></ol><h2 id="后期优化"><a href="#后期优化" class="headerlink" title="后期优化"></a>后期优化</h2><p>家庭网络换成1G带宽，扩展链路聚合。路由器换成了Buffalo AG300H，交换机换成了Cisio SLM2008，这样家里千兆OK了，但是发现丫我的无线是100M的WAN和LAN，电视机是100M口，一口老血吐出来。电视机的话，使用Xbox One S看得了，1000M口。无线路由器有空再换个好点的吧。开始装修的时候就是考虑NAS链路聚合的，毕竟多设备同时访问NAS的话，不链路聚合的话可能会成为瓶颈。到时候NAS换了PCIe的双网卡，硬盘只要4口，全换成4T盘，这样也OK的。</p><h3 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h3><p>PXE的方案我使用的是DHCP Server在OpenWrt，然后tftp server在NAS。</p><p>DHCP配置<code>/etc/config/dhcp</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config boot &#x27;linux&#x27;</span><br><span class="line">        option filename &#x27;pxelinux.0&#x27;</span><br><span class="line">        option serveraddress &#x27;192.168.1.222&#x27;</span><br><span class="line">        option servername &#x27;Liangwu PXE SERVER&#x27;</span><br></pre></td></tr></table></figure><p>tftp-hpa配置。这里我在NAS上面直接将tftp跑在docker里面的。下载<a target="_blank" rel="noopener" href="https://mirrors.ustc.edu.cn/debian/dists/stretch/main/installer-amd64/current/images/netboot/netboot.tar.gz">Debian netboot</a>，并解压到res目录。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  tftp-hpa:</span><br><span class="line">    image: jumanjiman/tftp-hpa</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;69:69/udp&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./res/debian-installer/amd64/boot-screens/syslinux.cfg:/tftpboot/pxelinux.cfg/default:ro</span><br><span class="line">      - ./res/debian-installer:/tftpboot/debian-installer:ro</span><br><span class="line">      - ./res/windows:/tftpboot/windows:ro</span><br></pre></td></tr></table></figure><p>修改<code>./res/debian-installer/amd64/boot-screens/syslinux.cfg</code>，增加下面内容支持windows安装。制作PE镜像，加入网卡驱动，这些在<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-mount-and-customize">Microsoft文档</a>可以找到。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">label 9</span><br><span class="line">menu label Install Windows 7</span><br><span class="line">        KERNEL memdisk</span><br><span class="line">        INITRD windows/winpe_7.iso</span><br><span class="line">        APPEND iso raw</span><br><span class="line">prompt 0</span><br><span class="line">timeout 0</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-tags"><a href="/tags/SSH/" rel="tag"># SSH</a> <a href="/tags/Debian/" rel="tag"># Debian</a> <a href="/tags/NAS/" rel="tag"># NAS</a> <a href="/tags/J3455/" rel="tag"># J3455</a> <a href="/tags/NextCloud/" rel="tag"># NextCloud</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2018/12/01/archlinux-installation/" rel="prev" title="ArchLinux安装"><i class="fa fa-angle-left"></i> ArchLinux安装</a></div><div class="post-nav-item"><a href="/2019/04/05/openwrt-restricting-internet-access-based-on-mac-address/" rel="next" title="OpenWrt限制设备连接Internet">OpenWrt限制设备连接Internet <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Liangwu</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a></div></div></footer><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script></body></html>