<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="manifest" href="/manifest.json"><meta name="google-site-verification" content="Ke_HLBE1VTaPAM92Uvmu83gGuH28rv4bw7lfrfr2Fc8"><meta name="msvalidate.01" content="E071B510B0369A55948886E7534E0B0C"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"notes.guoliangwu.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="Idea, Action"><meta property="og:type" content="blog"><meta property="og:title" content="Liangwu&#39;s Notes"><meta property="og:url" content="https://notes.guoliangwu.com/page/2/index.html"><meta property="og:site_name" content="Liangwu&#39;s Notes"><meta property="og:description" content="Idea, Action"><meta property="og:locale" content="en_US"><meta property="article:author" content="Liangwu"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://notes.guoliangwu.com/page/2/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Liangwu's Notes</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Liangwu's Notes</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Just note anything</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Liangwu" src="https://avatars.githubusercontent.com/u/1228007?v=4"><p class="site-author-name" itemprop="name">Liangwu</p><div class="site-description" itemprop="description">Idea, Action</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/glw119" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://weibo.com/glw119" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a> </span><span class="links-of-author-item"><a href="https://twitter.com/glw119" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;glw119" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a></span></div></div></div></div></aside></div><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2019/04/05/byr-pt-spider/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2019/04/05/byr-pt-spider/" class="post-title-link" itemprop="url">北邮人PT种子下载</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-04-05 22:50:15" itemprop="dateCreated datePublished" datetime="2019-04-05T22:50:15+08:00">2019-04-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>之前一直通过SS使用VPS的IPv6是可以使用bt.byr.cn的，但是从几个月前一直无法使用，使用浏览器用代理后直接跳转到一个com.com的网站，不清楚是什么原因，但是使用curl确实是没有问题的<code>curl -x socks5://127.0.0.1:1080 -I https://bt.byr.cn/login.php</code>。前者返回的是302，后者是200。</p><p>后来找到了<a target="_blank" rel="noopener" href="https://gist.github.com/zYeoman/1d841c5a1227697bc82c81f4acf1f2ad">zYeoman</a>的代码，也不清楚当时是怎么搜到的，可以用，但是HTML格式好像有变动，这个好解决，稍微程序动下就好了。</p><p>然后自己新建了个<a target="_blank" rel="noopener" href="https://github.com/glw119/byr-spider">byr-spider库</a>，方便自己使用吧，加了requirements.txt，加了代理，这个我可以在没有IPv6的情况下，通过代理一样下载种子，然后看有什么自己喜欢需要下载的，就把种子文件传到VPS自己下载就好了。</p><p>在家里的NAS机器上新增了定时任务，自己拉最新的种子文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@hourly <span class="built_in">cd</span> ~/byr &amp;&amp; pipenv run python byr.py &gt; log.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure><script src="//gist.github.com/5ba7da7936935a7cd9d7823e32373f82.js?file=byr.py"></script></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2019/04/05/openwrt-restricting-internet-access-based-on-mac-address/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2019/04/05/openwrt-restricting-internet-access-based-on-mac-address/" class="post-title-link" itemprop="url">OpenWrt限制设备连接Internet</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-04-05 21:29:46" itemprop="dateCreated datePublished" datetime="2019-04-05T21:29:46+08:00">2019-04-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>有一天查看OpenWrt设备状态的时候，突然发现一个熟悉的Mac地址，而且没有主机名。感觉心里不踏实，毕竟已经做了最初级的SSID隐藏，我脑袋里想到的第一反应就是之前有人来家里玩的时候，连了家里的WIFI，而且还使用了什么WIFI密码盒子之类的软件，这类软件拿到GPS定位或运营商定位，再结合扫描的SSID信息，可能已经把我的WIFI信息和密码传到服务器上面了。这样我就必须要做进一步的改善了，当然最简单的方法就是改密码，但是家里有其他人使用，改动比较费事；再想到的就是WIFI连接时的<a target="_blank" rel="noopener" href="https://medium.com/openwrt-iot/lede-openwrt-restricting-network-access-based-on-mac-5a012302e09f">MAC白名单验证</a>，但我想这个可能通过抓包也能好样的出来，不是太好。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>家里的路由器基本都是用的OpenWrt，应该能通防火墙规则来做点文章，思路是MAC地址白名单，可连LAN，无法使用WAN，放狗搜了下，找到一些文章。<a target="_blank" rel="noopener" href="https://bokunokeiken.wordpress.com/2015/06/27/how-to-block-device-on-openwrt-based-on-mac-address/">How to Block Device on OpenWRT Based on MAC Address</a></p><h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p>其实就是在Network -&gt; Firewall里的Zones中的Zone Lan &#x3D;&gt; REJECT，然后再给需要使用Internet的设备增加相应规则。改动就是修改OpenWrt中的<code>/etc/config/firewall</code>。</p><script src="//gist.github.com/aaf62cc2b953420d7d044108ed78ae1c.js?file=firewall"></script><p>最后一点就是内网做好防护工作，OpenWrt的SSH禁用密码，只能使用密钥；uhttpd修改为SSL，且修改端口。s</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2019/03/22/nas-setting-up/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2019/03/22/nas-setting-up/" class="post-title-link" itemprop="url">NAS搭建</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-03-22 08:50:16" itemprop="dateCreated datePublished" datetime="2019-03-22T08:50:16+08:00">2019-03-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="NAS搭建"><a href="#NAS搭建" class="headerlink" title="NAS搭建"></a>NAS搭建</h1><p>其实很早的时候就想搞一台NAS玩了，毕竟有很多想收藏的高清视频，还有一些自己私人资料，不方便存在云盘里面的。之前HP Gen8机器还是不错，扩展性也非常不错，只是感觉有点小贵，然后就是风扇噪音问题比较严重，查了下说是HP虚拟的一个Raid卡造成的问题，在*nix下面无法获取到硬盘的温度，导致风扇会以最大转速工作。当然查Gen8的资料是最近正式想整一台NAS后才开始。之前是用蛮早的一台上网本，好像是三星N2600之类的型号吧，装了CentOS，专门下载PT和存照片。后来空间不够用，就想起还是组一台NAS吧，正好家里有6台笔记本(Surface Pro 4, Thinkpad T400, Thinkpad E330, Thinkpad E420 x 2, Samung N2600)，2.5寸硬盘有6个，本着不能浪费的原则，就开始整NAS了。</p><h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>19年春节前就一直想着这个事情，老天也是“给力”，春节期间还真是没有出过一个太阳，就宅在家里想着怎么组这个NAS。</p><h3 id="FreeBSD-x2F-ZFS-x2F-Jail"><a href="#FreeBSD-x2F-ZFS-x2F-Jail" class="headerlink" title="FreeBSD&#x2F;ZFS&#x2F;Jail"></a>FreeBSD&#x2F;ZFS&#x2F;Jail</h3><p>FreeBSD很稳定，port也非常好用。之前工作的主力系统是Gentoo，所以对FreeBSD很有好感。但是ZFS一直没有正式接触过，于是把<a target="_blank" rel="noopener" href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/">FreeBSD Handbook</a>好好地看了下，确实ZFS很强大，可以忘掉Raid，忘掉分区，不同目录设置不能参数适应不同用途（加密，压缩等等），快照功能。还有Jail可用，用途有点类似Linux下的Docker，可以把程序关到Jail里运行，不影响主系统。</p><p>但是真正用起来感觉还有好多东西需要深入研究，但又没那么多时间。</p><ol><li>ZFS很强大，但同时也是内存大户，推荐是1T配1G内存，然后建议是配ECC内存（这个作者原意思是关心数据的话，不管是什么文件系统，都建议ECC）。现在内存不是太贵，但是要自己组NAS的话，ECC内存好像不好搞定。</li><li>ZFS优化比较麻烦。在虚拟机里用ZFS和UFS测试NextCloud&#x2F;MySQL时，发现ZFS明显慢很多。放狗搜了下，关于ZFS优化MySQL这方面，有蛮多参数需要配置的。</li><li>ZFS快照功能暂时好像用不上，没这需要。但蛮喜欢加密和压缩功能的。</li><li>Jail配置NAT网络比较麻烦，不如Docker来得方便。而且PF与iptables又不一样，还要查不少资料，烦。</li><li>担心FreeBSD的硬件兼容性，不能够让NAS达到最节能的状态。</li></ol><p>所以最后还是放弃了FreeBSD。</p><h3 id="OpenMediaVault-OMV"><a href="#OpenMediaVault-OMV" class="headerlink" title="OpenMediaVault(OMV)"></a>OpenMediaVault(OMV)</h3><p>之前本来确实是想用FreeBSD来组NAS的，后来@kurtyan推荐使用OMV。然后就是虚拟机里搞了一把，有几个槽点吧。</p><ol><li>OMV镜像安装不支持UEFI，这个锅应该让Debian 8背吧。。。然后就是OMV镜像安装时，好像要选整个硬盘，这个有点恶心，后来干脆自己先装好Debian 9然后再装OMV。</li><li>感觉Web管理页面上有太多我不想要，也用不着的功能，看着比较浪费。</li></ol><p>感觉OMV比较适合新手，界面什么的还是比较友好的。后来一想这个web管理界面，FreeBSD的webadmin也可以管理啊，一查Linux也可以用webadmin。但最后还是没有用webadmin，自己从基层组算了。</p><h3 id="Debian-x2F-LVM-x2F-Docker"><a href="#Debian-x2F-LVM-x2F-Docker" class="headerlink" title="Debian&#x2F;LVM&#x2F;Docker"></a>Debian&#x2F;LVM&#x2F;Docker</h3><p>OMV是基于Debian的，还不如自己搭建想要的功能呢。刚开始有考虑CentOS，但本人不喜欢它的图形安装界面，好像比Debian耗资源一些，就pass掉了。</p><p>既然是自己用的NAS就需要考虑下数据的安全问题，以防硬盘突然挂掉，开始考虑的是软raid，重要数据raid 1，视频数据raid 0，后来考虑再三还是放弃了软raid的方案，买的是4盘位机箱，比较少，还是用USB3.0外挂硬盘，定时备份重要数据，特别重要的文件就GnuPG加密后传网盘。还有一个就是使用LVM管理分区，这样可以最大限度地使用硬盘空间，后面系统配置的时候再详细谈下。其实ZFS对于这两点很适合，send&#x2F;recv备份很方便，分区根本不需要管，把不同硬盘加到不同pool就OK了。</p><p>还有一个选Linux的原因应该就是Docker了。这样可以很大程序减少应用程序对系统的干扰，把能在Docker下面跑的都放进去，各自跑各自的。</p><p>所以我最后选择了Debian开干。</p><h2 id="硬件配置"><a href="#硬件配置" class="headerlink" title="硬件配置"></a>硬件配置</h2><p>硬件配置最开始设想的是4个SATA3接口，2个网卡，PICe接口进行扩展，CPU性能无所谓。网上搜了不少，候选方案有下面几个：</p><ol><li>HP Gen8。2个数据网口，1个管理网口。这点对于服务器管理非常重要，丢在某个角落完全不用管，可直接iLO进行所有操作。有4个盘位，还有内置的USB、SD卡插口。就是有点小贵，还有风扇噪音。</li><li>HP Gen10。2个数据网口，4个盘位，AMD CPU。感觉也OK，风扇不吵了，但是少了iLO，而且低配价格也很高。</li><li>GA N3160主板。2个数据网口，4个盘位，PCI插槽。刚开始是冲是它去的，最后PCI插槽放弃了，而且价格比J3455贵100多大洋。</li><li>ASRock J4105&#x2F;J3455。1个数据网口，4个盘位，PCIe x1插槽。两块板CPU有差别，内存一个是DDR4，一个是DDR3。但是J3455支持16G，J4105只支持8G。最后选择了J3455，因为它便宜 :)</li></ol><p>其实最早是蛮想2个网口链路聚合的，这样多处同时从NAS存取数据的时候，网络不会成为其瓶颈，后来想了想，估计同时多处使用NAS的情况最近几年都不会有，后面如果确实有需要，可以PCIe转双网卡就OK。家里网线是六类双屏蔽（那个硬啊，现在有点后悔用双屏蔽的了），交换机Linksys SLM2008，路由器Buffalo WZR-HP-AG300H，光纤入户100M，所以暂时屋内1G局域网应该够用了。</p><p>这里给自己上了一课吧，当时查ASRock官网J3455的时候，就注意到SATA的第3，4接口是ASMedia ASM1061出来的，跟我后来买的PCIe转SATA接口是一样的。好像最高是400MB&#x2F;s，就是如果这几个接口上SSD的话，可能会影响期性能。而且PCIe 2.0 x1的最高速度是500MB&#x2F;s，这块也成了影响其性能的要点了。</p><p>电源选择方面，可以选小的DC转24针这种，完全没有噪音，功耗也低，但是但是贵啊。。。。最后选了一个ENP 7025B 250W的Flex电源，有噪音，功耗也比DC高，但是但是便宜啊 :(</p><p>开始机箱自带的风扇是12cm，直接从电源取电，也就是说一直是全速状态。看了下J3455板是CPU和机箱风扇电源接口都是3线的，所以可以调节风扇转速，后来又购了1个12cm 1500rpm的3线风扇。可惜板子不支持4线的风扇。。。</p><p>嗯，后面再详细记录下系统方面的配置吧。</p><h2 id="软件配置"><a href="#软件配置" class="headerlink" title="软件配置"></a>软件配置</h2><h3 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h3><p>Debian安装比较简单了，将网络安装的ISO写入到U盘，安装就OK了。其实完全可以用PXE来搞定，后面再记录下PXE吧。</p><h3 id="LVM"><a href="#LVM" class="headerlink" title="LVM"></a>LVM</h3><p>LVM里面有几个名词，PV物理卷（可以是硬盘，分区，文件），VG卷组（由物理卷组成的组，有点类似ZFS的Pool），LV逻辑卷（类似普通分区，可格式化，挂载）。</p><h4 id="PV操作"><a href="#PV操作" class="headerlink" title="PV操作"></a>PV操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/xxx bs=512 count=1</span><br><span class="line">pvcreate /dev/xxx</span><br><span class="line">pvs</span><br><span class="line">pvremove /dev/xxx</span><br></pre></td></tr></table></figure><h4 id="VG操作"><a href="#VG操作" class="headerlink" title="VG操作"></a>VG操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vgcreate vg-nas /dev/xxx /dev/xxx</span><br><span class="line">vgextend vg-nas /dev/xxx</span><br><span class="line">vgreduce vg-nas /dev/xxx</span><br><span class="line">vgchange -a y/n vg-nas <span class="comment"># activating/deactivating vg</span></span><br><span class="line">vgremove vg-nas</span><br><span class="line">vgrename vg-nas-old vg-nas-new</span><br><span class="line">vgs</span><br></pre></td></tr></table></figure><h4 id="LV操作"><a href="#LV操作" class="headerlink" title="LV操作"></a>LV操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 1T -n lv-data vg-nas <span class="comment"># linar</span></span><br><span class="line">lvcreate -l 100%FREE -n lv-other vg-nas</span><br><span class="line">lvs</span><br><span class="line">lvextend -l +100%FREE -n vg-name lv-name <span class="comment"># /dev/vg-name/lv-name</span></span><br><span class="line">resize2fs /dev/vg-name/lv-name</span><br><span class="line">lvreduce --resizefs -L 500G vg-name/lv-name</span><br></pre></td></tr></table></figure><p>LVM调整挂载点容量大小就比较方便了，不明白的时候可以看RedHat的在线文档，写得很详细。</p><h3 id="sshd"><a href="#sshd" class="headerlink" title="sshd"></a>sshd</h3><p>默认SSHD是密码登录的，可以用<code>sshkey-gen</code>生成密钥后，再用<code>ssh-copy-id</code>将公钥复制到远程主机。NAS我需要internet也能访问到，这样SSHD默认配置就不太合适了，需要改几个地方，其实打开<code>/etc/ssh/sshd_config</code>就一目了然，从配置字面上就能知道啥作用了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Protocol 2</span><br><span class="line"></span><br><span class="line">PermitRootLogin no</span><br><span class="line">StrictModes yes</span><br><span class="line">MaxAuthTries 6 #BAN IP的话可以用Fail2ban</span><br><span class="line">MaxSessions 10</span><br><span class="line"></span><br><span class="line">AuthorizedKeysCommand none</span><br><span class="line">AuthorizedKeysCommandUser nobody</span><br><span class="line"></span><br><span class="line">PasswordAuthentication no</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line"></span><br><span class="line">AllowGroups sshusers #将需要使用ssh的用户加入sshusers用户组</span><br></pre></td></tr></table></figure><h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><p>之前内网穿透使用的是<a href="https://notes.guoliangwu.com/2018/11/18/use-ssh-proxy/">ssh端口转发</a>，NAS用远程端口转发<code>-R 2222:127.0.0.1:22 VPS</code>(VPS的2222端口转发到NAS的22端口)，然后在终端机使用本地端口转发<code>-L 4444:127.0.0.1:2222 VPS</code>(终端机4444端口转发到VPS的2222端口)，这样在终端机<code>ssh -p 4444 localhost</code>就可以访问NAS了，很方便不是？后来好像有时候网络不稳定，掉线后NAS不会自己进行端口转发，然后就找到了现在用的<a href="https://notes.guoliangwu.com/2018/11/18/use-ssh-proxy/">frp</a>和<a target="_blank" rel="noopener" href="https://github.com/kuoruan/openwrt-frp">openwrt frp</a>。</p><p>其中frp VPS Server端的配置如下。其实程序自带的说明文件里说得很详细，认真看下就可以配得很好了。</p><figure class="highlight ini"><figcaption><span>/etc/frp/frps.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bind_udp_port</span> = <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tcp_bind_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dashboard_addr</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dashboard_user</span> = user</span><br><span class="line"><span class="attr">dashboard_pwd</span> = pwd</span><br><span class="line"></span><br><span class="line"><span class="attr">log_file</span> = /var/log/frps.log</span><br><span class="line"></span><br><span class="line"><span class="attr">log_info</span> = info</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">privilege_token</span> = privilege_token</span><br><span class="line"></span><br><span class="line"><span class="attr">max_pool_count</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">max_ports_per_client</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">authentication_timeout</span> = <span class="number">900</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><figcaption><span>frps.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=frps daemon</span><br><span class="line">After=network.target</span><br><span class="line">Wants=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">ExecStart=/usr/bin/frps -c /etc/frp/frps.ini</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.targe</span><br></pre></td></tr></table></figure><p>其中NAS的frp配置如下。OpenWrt的话，直接使用screen，<code>sleep 30 &amp;&amp; screen -dmS frpc frpc -c /etc/frp/frpc.ini</code>，加到<code>/etc/rc.local</code>。</p><figure class="highlight ini"><figcaption><span>frpc.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = VPS_IP</span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log_file</span> = /var/log/frpc.log</span><br><span class="line"><span class="attr">log_level</span> = info</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">privilege_token</span> = privilege_token</span><br><span class="line"></span><br><span class="line"><span class="attr">admin_addr</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">admin_port</span> = <span class="number">7400</span></span><br><span class="line"><span class="attr">admin_user</span> = admin_user</span><br><span class="line"><span class="attr">admin_passwd</span> = admin_pwd</span><br><span class="line"></span><br><span class="line"><span class="attr">pool_count</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">user</span> = nas</span><br><span class="line"><span class="attr">log_fail_exit</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">protocol</span> = tcp</span><br><span class="line"></span><br><span class="line"><span class="section">[ssh]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">2222</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><figcaption><span>frpc.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=FRP Client Daemon</span><br><span class="line">After=network.target</span><br><span class="line">Wants=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/frpc -c /etc/frp/frpc.ini</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=20s</span><br><span class="line">User=nobody</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="下载工具"><a href="#下载工具" class="headerlink" title="下载工具"></a>下载工具</h3><p>NAS的话必须要下载片子咯，BT&#x2F;PT使用的是transmission，普通其它下载用的是aria2。使用transmission需要下载几个包<code>apt install transmission-&#123;daemon, remote&#123;,-cli&#125;&#125;</code>，平时使用的话我在bash里加了下载几个alias。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> lcp=<span class="string">&#x27;rsync -avhW --no-compress --progress&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> t-remote=<span class="string">&#x27;transmission-remote -n user:password localhost&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> t-remote=<span class="string">&#x27;transmission-remote-cli -c user:password@localhost:9091&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> a-d=<span class="string">&#x27;aria2c -x 10 -j 1 --http-user user --http-passwd passwd&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="NextCloud"><a href="#NextCloud" class="headerlink" title="NextCloud"></a>NextCloud</h3><p>其中架NAS最重要的一点就是网盘，放一些家庭照片和视频，常跟老婆説，等以后崽结婚的时候，把小时候的照片拿出来看，哈哈哈。</p><p>之前家里用的是FreeBSD下面架设的，这次换成Debian，那肯定就用Docker来跑这些咯，以后迁移起来也是非常快的，打包带走。。。</p><figure class="highlight yaml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=pwd1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=pwd2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=nextcloud</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=nextcloud</span></span><br><span class="line">  <span class="attr">nextcloud:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nextcloud:15-fpm-alpine</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./html:/var/www/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nextcloud</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./html:/var/www/html</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中<code>./nginx/default.conf</code>可以直接参考<a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/15/admin_manual/installation/nginx.html">官网文档</a>，然后还有一点就是nginx和nextcloud的docker image中用户名ID不一致，这样共享的目录<code>./html</code>就不能同时使用。需要调整下，nginx的image很小，可以直接从它下手，nginx的Dockerfile如下。</p><figure class="highlight dockerfile"><figcaption><span>nginx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/:100:/:82:/g&#x27;</span> /etc/passwd; \</span></span><br><span class="line"><span class="language-bash">    sed -i <span class="string">&#x27;s/:101:/:82:/g&#x27;</span> /etc/passwd /etc/group</span></span><br></pre></td></tr></table></figure><h3 id="SAMBA"><a href="#SAMBA" class="headerlink" title="SAMBA"></a>SAMBA</h3><p>家里其他设备访问NAS估计用得最多的就是SAMBA了吧，直接在<code>/etc/samba/smb.conf</code>最后加上一些配置就OK了，也懒得再认真配置了，只要能访问到就OK。</p><figure class="highlight plaintext"><figcaption><span>smb.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[public]</span><br><span class="line">  comment = public</span><br><span class="line">  path = /data/BTDownloads</span><br><span class="line">  browsable = yes</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = no</span><br><span class="line">  guest ok = yes</span><br><span class="line">[videos]</span><br><span class="line">  comment = public</span><br><span class="line">  path = /mnt/videos</span><br><span class="line">  browsable = yes</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = no</span><br><span class="line">  guest ok = yes</span><br><span class="line">[win7]</span><br><span class="line">  comment = public</span><br><span class="line">  path = /mnt/cdrom</span><br><span class="line">  browsable = no</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = no</span><br><span class="line">  guest ok = yes</span><br><span class="line">[personal]</span><br><span class="line">  comment = personal</span><br><span class="line">  path = /mnt/nas/personal</span><br><span class="line">  browsable = no</span><br><span class="line">  create mask = 0660</span><br><span class="line">  directory mask = 0771</span><br><span class="line">  writable = yes</span><br><span class="line">  guest ok = no</span><br></pre></td></tr></table></figure><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>家里还有一些其他设备，比如路由器(OpenWrt)和Raspberry Pi，它们可以很方便的使用NFS，这样NAS提供NFS服务就可以了。修改<code>/etc/exports</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/mnt/nas/Tools  *(no_subtree_check,ro,all_squash,insecure,async)</span><br></pre></td></tr></table></figure><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>硬盘多了，功率也大，安装包<code>hdparm</code>可以设置硬盘standby的时间，据説可以延长使用时间，减小功耗，前提是不要设置得太小，硬盘磁头一停一启动地可能更耗硬盘。修改<code>/etc/hdparm.conf</code></p><figure class="highlight plaintext"><figcaption><span>/etc/hdparm.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb &#123;</span><br><span class="line">    spindown_time = 250</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>安装<code>hddtemp sensors</code>来读取温度值。</p><h2 id="BIOS设置"><a href="#BIOS设置" class="headerlink" title="BIOS设置"></a>BIOS设置</h2><p>关闭非必要功能，节能设置等</p><p>WOL，需要开启PCIE power on</p><h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><ol><li><p>NAS下载了很多片片，要传到手机上看，之前都是iTunes通过WIFI读取SAMBA共享文件，再传到VLC，慢得1B，还得再多开台电脑。后来了解到可以直接用<code>curl</code>传，方便了很多。<code>curl -F &quot;filename=&#39;filename&#39;&quot; -F &quot;files[]=@filepath&quot; http://VLC_IP/upload.json</code>，本来想写个shell脚本自动上传目录下的所有文件的，但是没有找到好的方法，干脆用python吧，直接造成shell脚本运行。 :(不会直接使用Python上传到VLC，POST传的东西跟平时有点不一样。。。</p></li><li><p>下载Dropbox文件，Bash脚本<a target="_blank" rel="noopener" href="https://github.com/andreafabrizi/Dropbox-Uploader">Dropbox Uploader</a>，在VPS上面下载Dropbox的照片，然后再传回来。</p></li><li><p>下载OneDrive文件，用windows里面的客户端可能是最简单的，但没有在NAS里面安装虚拟机，也不想平时再开台机器。后来想了一条路，Chrome下载OneDrive的照片目录，zip文件，然后打开Chrome开发工具，直接将刚才那个请求<code>Copy as cURL</code>，这样可以直接在NAS下载照片了。</p></li><li><p>Picasaweb。long long ago，那时候Google还没有被封，传照片就到Picasa，哈哈，里面好多年轻的照片啊。这里需要设置下，在Google Drive里面设置下，将Google Photos照片导入到Google Drive，然后使用<code>rclone</code>将里面的照片复制到本地。<code>rclone copy remote:Google\ Photos /mnt/photos -P</code></p></li><li><p>照片存了这么多份，肯定有重复的。最开始写了脚本进行查重，思路就是找出所有图片文件，对md5码，发现效率不高，后来放狗搜发现一个好工具<code>fdepes</code>。<code>find . ! -empty -type f -size +500k -size -50M -exec md5sum &#123;&#125; + | sort &gt; ~/allfiles</code>，然后再对allfiles文件用unique就能找出重复文件了。<code>fdupes -r -S -1 Data Documents nextcloud Pictures Work &gt; ~/allfiles</code>，这个也是找出所有重复文件，还可以直接使用<code>fdupes</code>快速删除重复文件。</p></li></ol><h2 id="后期优化"><a href="#后期优化" class="headerlink" title="后期优化"></a>后期优化</h2><p>家庭网络换成1G带宽，扩展链路聚合。路由器换成了Buffalo AG300H，交换机换成了Cisio SLM2008，这样家里千兆OK了，但是发现丫我的无线是100M的WAN和LAN，电视机是100M口，一口老血吐出来。电视机的话，使用Xbox One S看得了，1000M口。无线路由器有空再换个好点的吧。开始装修的时候就是考虑NAS链路聚合的，毕竟多设备同时访问NAS的话，不链路聚合的话可能会成为瓶颈。到时候NAS换了PCIe的双网卡，硬盘只要4口，全换成4T盘，这样也OK的。</p><h3 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h3><p>PXE的方案我使用的是DHCP Server在OpenWrt，然后tftp server在NAS。</p><p>DHCP配置<code>/etc/config/dhcp</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config boot &#x27;linux&#x27;</span><br><span class="line">        option filename &#x27;pxelinux.0&#x27;</span><br><span class="line">        option serveraddress &#x27;192.168.1.222&#x27;</span><br><span class="line">        option servername &#x27;Liangwu PXE SERVER&#x27;</span><br></pre></td></tr></table></figure><p>tftp-hpa配置。这里我在NAS上面直接将tftp跑在docker里面的。下载<a target="_blank" rel="noopener" href="https://mirrors.ustc.edu.cn/debian/dists/stretch/main/installer-amd64/current/images/netboot/netboot.tar.gz">Debian netboot</a>，并解压到res目录。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  tftp-hpa:</span><br><span class="line">    image: jumanjiman/tftp-hpa</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;69:69/udp&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./res/debian-installer/amd64/boot-screens/syslinux.cfg:/tftpboot/pxelinux.cfg/default:ro</span><br><span class="line">      - ./res/debian-installer:/tftpboot/debian-installer:ro</span><br><span class="line">      - ./res/windows:/tftpboot/windows:ro</span><br></pre></td></tr></table></figure><p>修改<code>./res/debian-installer/amd64/boot-screens/syslinux.cfg</code>，增加下面内容支持windows安装。制作PE镜像，加入网卡驱动，这些在<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-mount-and-customize">Microsoft文档</a>可以找到。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">label 9</span><br><span class="line">menu label Install Windows 7</span><br><span class="line">        KERNEL memdisk</span><br><span class="line">        INITRD windows/winpe_7.iso</span><br><span class="line">        APPEND iso raw</span><br><span class="line">prompt 0</span><br><span class="line">timeout 0</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/12/01/archlinux-installation/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/12/01/archlinux-installation/" class="post-title-link" itemprop="url">ArchLinux安装</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-12-01 23:33:53" itemprop="dateCreated datePublished" datetime="2018-12-01T23:33:53+08:00">2018-12-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>家里好几台电脑，现在有Surface Pro 4的Windows 10， Thinkpad T400的Windows 7和XUbuntu 18.04.1，老婆老的三星上网本NP110C的FreeBSD 11和CentOS 7， 公司电脑Thinkpad E550的Gentoo和XUbuntu 18.04.1。还有台破的Thinkpad E330，想着周末没啥事，就装个省点事的版本吧，本来是装好了Ubuntu，但是感觉不好，重新装个ArchLinux吧。</p><h2 id="EFI-x2F-GPT"><a href="#EFI-x2F-GPT" class="headerlink" title="EFI&#x2F;GPT"></a>EFI&#x2F;GPT</h2><p>其实以前也装过ArchLinux，是在T400上面。现在在E330上面，有一些地方不一样，主要是GPT和EFI的问题，所以就记录一下吧。</p><p>首先分区的时候，用的是<code>fdisk</code>，用GPT。大概分区方式如下</p><table><thead><tr><th>物理分区</th><th>文件系统</th><th>挂载点</th></tr></thead><tbody><tr><td>&#x2F;dev&#x2F;sda1</td><td>EFI System</td><td>&#x2F;boot</td></tr><tr><td>&#x2F;dev&#x2F;sda2</td><td>Ext4</td><td>&#x2F;</td></tr><tr><td>&#x2F;dev&#x2F;sda3</td><td>Ext4</td><td>&#x2F;data</td></tr><tr><td>&#x2F;dev&#x2F;sda4</td><td>Swap</td><td></td></tr></tbody></table><p>对<code>EFI</code>进行分区，<code>mkfs.fat -F32 /dev/sda1</code>。安装相应软件<code>efibootmgr</code>，不知道有没有用，反正我没有试过不安装有没有影响。</p><h3 id="GRUB安装"><a href="#GRUB安装" class="headerlink" title="GRUB安装"></a>GRUB安装</h3><p>EFI的GRUB有点不一样，以前只需要<code>grub-install /dev/sda</code>就好了，但是现在不行了。现在GRUB安装如下，其中<code>/boot</code>是之前分区的EFI分区，Ubuntu就是另外一分单独的分区，它是单独挂载在<code>/boot/EFI</code>。<code>bootloader-id</code>是EFI启动界面显示的ID。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB</span><br><span class="line">grub-mkconfig -o /etc/grub/grub.cfg</span><br></pre></td></tr></table></figure><h2 id="wireless"><a href="#wireless" class="headerlink" title="wireless"></a>wireless</h2><p>笔记本肯定要用无线上网嘛，可是我家SSID是隐藏的，就用了自带的<code>netctl</code>控制。在<code>/etc/netctl/examples</code>下面有好多示例文档，用<code>wireless-wpa</code>就好了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/netctl/examples /etc/netctl/liangwu</span><br><span class="line">netctl start liangwu</span><br></pre></td></tr></table></figure><p>这样在安装的时候就可以上网了。但是安装的新系统，如果不安装netctl或其它网络相关软件的话，新系统还是无法上网。其中netctl还有一些依赖需要安装。<code>dialog</code>用于wifi-menu使用，<code>wpa_supplicant</code>用于密钥使用。</p><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p><code>hostnamectl</code>设置主机名</p><p><code>timedatectl</code>设置时区等等</p><h2 id="Desktop-Environment"><a href="#Desktop-Environment" class="headerlink" title="Desktop Environment"></a>Desktop Environment</h2><p>驱动需要根据自己环境变动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pacman -S xorg-server xf86-video-intel xf86-video-nouveau xfce4 xfce4-goodies lightdm lightdm-gtk-greeter lightdm-gtk-greeter-settings networkmanager nm-connection-editor network-manager-applet papirus-icon-theme alsa-utils pavucontrol pasystray pulseaudio pulseaudio-alsa dnsutils fcitx fcitx-configtool fcitx-gtk3 fcitx-qt5</span><br><span class="line">vim /etc/lightdm/lightdm.conf</span><br><span class="line">vim /etc/lightdm/lightdm--gtk-greeter.conf</span><br><span class="line">vim /etc/systemd/logind.conf</span><br><span class="line">systemctl <span class="built_in">enable</span> lightdm.service</span><br><span class="line">systemctl <span class="built_in">enable</span> NetworkManager</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/12/01/mybatis-faq/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/12/01/mybatis-faq/" class="post-title-link" itemprop="url">MyBatis常见问题</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-12-01 22:51:15" itemprop="dateCreated datePublished" datetime="2018-12-01T22:51:15+08:00">2018-12-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="MyBatis-FAQ"><a href="#MyBatis-FAQ" class="headerlink" title="MyBatis FAQ"></a>MyBatis FAQ</h1><p>用MyBatis有点点时间了，也碰到一些问题。放狗搜了之后，发现官方github上的<a target="_blank" rel="noopener" href="https://github.com/mybatis/mybatis-3/wiki/FAQ">FAQ</a>已经有一些东西，是可以先看看的。</p><h2 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h2><p>之前用MyBatis进行批量插入时，一直都在MyBatis的Mapper.xml里面用<code>foreach</code>拼成一个比较长的SQL，这个时候MySQL和Oracle的拼法还有点不一样。MySQL可以直接用<code>INSERT INTO (id) VALUES (1),(2),(3)</code>这种形式，而Oracle不行，Oracle需要且<code>UNION ALL</code>或<code>FROM DUAL</code>或直接<code>BEGIN ... END</code>。</p><p>后来了解看<a target="_blank" rel="noopener" href="https://www.renren.io/">renren security</a>的源码时候，发现有使用<a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">MyBatis Plus</a>，在MyBatis Plus里面的<code>ServiceImpl&lt;M extends BaseMapper&lt;T&gt;, T&gt;</code>类中有个<code>saveBatch</code>方法，看日志发现他不是用接长SQL方法实现的，跟<code>Groovy</code>里面的<code>batch</code>操作是一样的。后来搜索后发现MyBatis其实有个<code>Executor</code>本身就带批量操作功能。。。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession(ExecutorType.BATCH, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">    userList.forEach(userMapper::insert);</span><br><span class="line">    sqlSession.flushStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实我感觉应该是自己对JDBC不熟悉的原因吧，等有时间了去专门学习学习。这个我碰到一个坑，就是Spring boot进行JUnit测试操作的时候，在方法上加上<code>@Transactional</code>，事务回滚。可能是Spring boot test里面本身对事务就是这样处理的？这个有时间也是需要去解决的。&#x2F;&#x2F; TODO</p><h2 id="基本类型-String-Integer等-的列表映射"><a href="#基本类型-String-Integer等-的列表映射" class="headerlink" title="基本类型(String, Integer等)的列表映射"></a>基本类型(String, Integer等)的列表映射</h2><p>如果一个查询结果只有一列，这样返回的列表很容易进行映射。但是当一个对象里面有两个属性，一个ID，一个基本类型列表时，在之前查MyBatis文档的时候没有发现，后来在网上搜到了，映射的时候还是用<code>collection</code>，但是里面的只填一个<code>result column</code>。刚好在MyBatis FAQ里面也看到了。搬过来吧。</p><p>比如SQL搜索结果是</p><table><thead><tr><th>id</th><th>str</th></tr></thead><tbody><tr><td>1</td><td>A</td></tr><tr><td>2</td><td>B</td></tr></tbody></table><p>Java对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeBean</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Integer id;</span><br><span class="line">  <span class="keyword">private</span> List&lt;String&gt; strings;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>XML映射如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;SomeBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;strings&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;string&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;str&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure><p>另外官方其它的FAQ还有变量使用时<code>#&#123;&#125;</code>和<code>$&#123;&#125;</code>的区别：$在生成ps的时候，就已经替换了，存在安全问题，#在生成ps的时候，是用?代替，运行的时候再进行值代入。</p><p>SQL LIKE，这个有好多实现的方法，比如String自带%，使用<code>bind</code>，直接在SQL里面使用字符拼接。</p><p>插入时将自动生成的key返回，在insert映射的时候加入<code>useGeneratedKeys=&quot;true&quot; keyProperty=&quot;id&quot;</code>。</p><p>mapper方法传参使用变量名，这个直接使用注解<code>@Param</code>，或直接包装成对象或Map，或<code>mybatis.configuration.use-actual-param-name= true</code></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/11/18/use-ssh-proxy/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/11/18/use-ssh-proxy/" class="post-title-link" itemprop="url">SSH端口转发</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-18 23:05:31" itemprop="dateCreated datePublished" datetime="2018-11-18T23:05:31+08:00">2018-11-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="SSH端口转发"><a href="#SSH端口转发" class="headerlink" title="SSH端口转发"></a>SSH端口转发</h1><p><code>ssh</code>真的是很好用啊，传文件，本地&#x2F;远程&#x2F;动态端口转发，远程，X转发等等。X转发当时搞过一次，服务器没有安装X环境，无图形界面，要安装Oracle，当时搞了半天，用静默安装的形式安装好了一台。后来发现可以用SSH X转发，图形界面在我的机器上，实际安装程序在服务器上，好好玩啊。</p><p>嗯嗯，总结下在实际工作中使用最多的就是端口转发了。</p><h2 id="本地端口转发"><a href="#本地端口转发" class="headerlink" title="本地端口转发"></a>本地端口转发</h2><p>本地端口转发的命令是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L [bind_address:]port:host:hostport gate-way-server</span><br></pre></td></tr></table></figure><p>ssh文档中对本地端口转发的说明：</p><blockquote><p>Specifies that the given port on the local (client) host is to be forwarded to the given host and port on the remote side. This works by allocating a socket to listen to port on the local side, optionally bound to the specified bind_address. Whenever a connection is made to this port, the connection is forwarded over the secure channel, and a connection is made to host port hostport from the remote machine. Port forwardings can also be specified in the configuration file. IPv6 addresses can be specified with an alternative syntax:<br>[bind_address&#x2F;]port&#x2F;host&#x2F;hostport or by enclosing the address in square brackets. Only the superuser can forward privileged ports. By default, the local port is bound in accordance with the GatewayPorts setting. However, an explicit bind_address may be used to bind the connection to a specific address. The bind_address of ‘’localhost’’ indicates that the listening port be bound for local use only, while an empty address or ‘*’ indicates that the port should be available from all interfaces.</p></blockquote><p>我的理解就是：本地开一个端口(<code>port</code>)，访问这个端口的效果和<code>gate-way-server</code>访问<code>host:hostport</code>的效果一样。这样我体会到的最大的用处就是可以访问受限制(<code>gate-way-server</code>)的内网端口。</p><p>比如我在外面出差，想访问公司内部<code>server-A</code>的<code>3389</code>端口，<code>server-B</code>的<code>3306</code>端口，<code>server-C</code>的<code>1521</code>端口。但是这些端口肯定是不会对外开放的，我访问<code>server-outer</code>服务器对外暴露的<code>22</code>端口。于是我通过下面的命令就可以解决我的需求。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 3389:server-A:3389 -L 3306:server-B:3306 -L 1521:server-C:1521 -L 2222:localhost:22 server-outer -fNnC</span><br></pre></td></tr></table></figure><p>这样，我就可以直接访问本地的<code>3389</code>, <code>3306</code>, <code>1521</code>, <code>2222</code>端口来达到访问<code>server-A:3389</code>, <code>server-B:3306</code>, <code>server-C:1521</code>, <code>server-outer:22</code>端口的目的了。可能表述的不是太清楚，网上有几张图说明得很直白。</p><p><img data-src="https://i.stack.imgur.com/a28N8.png" alt="Local port forwarding"></p><h2 id="远程端口转发"><a href="#远程端口转发" class="headerlink" title="远程端口转发"></a>远程端口转发</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -R [bind_address:]port:host:hostport remote-server</span><br></pre></td></tr></table></figure><blockquote><p>Specifies that the given port on the remote (server) host is to be forwarded to the given host and port on the local side. This works by allocating a socket to listen to port on the remote side, and whenever a connection is made to this port, the connection is forwarded over the secure channel, and a connection is made to host port hostport from the local machine.</p></blockquote><blockquote><p>Port forwardings can also be specified in the configuration file. Privileged ports can be forwarded only when logging in as root on the remote machine. IPv6 addresses can be specified by enclosing the address in square braces or using an alternative syntax:<br>[bind_address&#x2F;]host&#x2F;port&#x2F;hostport.</p></blockquote><blockquote><p>By default, the listening socket on the server will be bound to the loopback interface only. This may be overridden by specifying a bind_address. An empty bind_address, or the address ‘*’, indicates that the remote socket should listen on all interfaces. Specifying a remote bind_address will only succeed if the server’s GatewayPorts option is enabled (see sshd_config(5)).</p></blockquote><blockquote><p>If the port argument is ‘0’, the listen port will be dynamically allocated on the server and reported to the client at run time.</p></blockquote><p>大概意思就是在<code>remote-server</code>上面绑定一个<code>port</code>，访问这个<code>port</code>的效果，就和本机现在访问<code>host:hostport</code>效果一样。</p><p>这种情况我也有使用，比如某处有两台电脑，<code>pc-1</code>能访问外网，<code>pc-2</code>不能访问外网，但<code>pc-1</code>和<code>pc-2</code>能互通。这时我在公司想访问<code>pc-1</code>和<code>pc-2</code>的<code>3389</code>端口，这个时候我就可以在<code>pc-1</code>机器上执行:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -R 13389:localhost:3389 -R 23389:pc-2:3389 remote-server</span><br></pre></td></tr></table></figure><p>其中<code>remote-server</code>为公司的一台电脑，互联网可以访问。这样我直接访问<code>remote-server</code>的<code>13389</code>和<code>23389</code>端口就可以直接连接到<code>pc-1:3389</code>和<code>pc-2:3389</code>端口了，十分好用啊。</p><p>哈哈，是不是相当于一个简单的内网穿透功能了。</p><p><img data-src="https://i.stack.imgur.com/a28N8.png" alt="Remote port forwarding"></p><h2 id="动态端口转发"><a href="#动态端口转发" class="headerlink" title="动态端口转发"></a>动态端口转发</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D port remote-server</span><br></pre></td></tr></table></figure><blockquote><p>Specifies a local ‘’dynamic’’ application-level port forwarding. This works by allocating a socket to listen to port on the local side, optionally bound to the specified bind_address. Whenever a connection is made to this port, the connection is forwarded over the secure channel, and the application protocol is then used to determine where to connect to from the remote machine. Currently the SOCKS4 and SOCKS5 protocols are supported, and ssh will act as a SOCKS server. Only root can forward privileged ports. Dynamic port forwardings can also be specified in the configuration file.</p></blockquote><blockquote><p>IPv6 addresses can be specified with an alternative syntax:<br>[bind_address&#x2F;]port or by enclosing the address in square brackets. Only the superuser can forward privileged ports. By default, the local port is bound in accordance with the GatewayPorts setting. However, an explicit bind_address may be used to bind the connection to a specific address. The bind_address of ‘’localhost’’ indicates that the listening port be bound for local use only, while an empty address or ‘*’ indicates that the port should be available from all interfaces.</p></blockquote><p>通过本地的port访问互联网，相当于通过remote-server来访问互联网。</p><p>嗯嗯，以前用来当梯子用，后来墙升级，很不稳定，后来好像大家都没用它来当梯子了。当然墙应该不是破解了ssh，应该是只流量识别吧。</p><p><img data-src="https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/image005.jpg" alt="Dynmaic port forwarding"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/aix/library/au-sshsecurity/index.html">SSH 安全性和配置入门</a></p><p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/">实战 SSH 端口转发</a></p><p><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot">What’s ssh port forwarding and what’s the difference between ssh local and remote port forwarding [duplicate]</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/11/18/npm-install-global-without-sudo/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/11/18/npm-install-global-without-sudo/" class="post-title-link" itemprop="url">npm全局安装包需要root权限问题</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-18 22:31:27" itemprop="dateCreated datePublished" datetime="2018-11-18T22:31:27+08:00">2018-11-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="npm包安装问题"><a href="#npm包安装问题" class="headerlink" title="npm包安装问题"></a>npm包安装问题</h1><p>之前在家基本都是用Surface Pro 4所以基本也就没有安装Nodejs。今天晚上正好有点时间，就把老的Thinkpad T400拿出来，写点东西总结东东吧，要不一直不总结，埋头处理工作，感觉一直没有进步。</p><p>感觉还有好多东西没有写，<code>SSH Local/Remote Proxy</code>，<code>kubernetes环境搭建(not hard way)</code>，<code>gitlab及runner在k8s里面搭建</code>，<code>MyBatis学习</code>，这些东西下周的时间全要写下来吧，要不全都要忘记了。</p><p>npm在天朝第一步应该是用<a target="_blank" rel="noopener" href="http://npm.taobao.org/">cnpm</a>吧，这一点我还是蛮喜欢alibaba的，在国内搞了一些方便开发者的镜像。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><p>这里<code>-g</code>就全局安装需要root权限，所以需要改下npm包管理的配置。</p><ol><li>创建包安装目录</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/.npm-packages</span><br></pre></td></tr></table></figure><ol start="2"><li>配置<code>npm</code>，将全局安装的包安装到上一步创建的目录</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;prefix=<span class="variable">$&#123;HOME&#125;</span>/.npm-packages&quot;</span> &gt;&gt; ~/.npmrc</span><br></pre></td></tr></table></figure><ol start="3"><li>配置环境<code>PATH</code>去正确目录查找<code>npm</code>包和<code>man</code>文件。将下面内容加入到<code>~/.bashrc</code>或<code>~/.zshrc</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NPM_PACKAGES=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/.npm-packages&quot;</span></span><br><span class="line">PATH=<span class="string">&quot;<span class="variable">$NPM_PACKAGES</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> MANPATH</span><br><span class="line"><span class="built_in">export</span> MANPATH=<span class="string">&quot;<span class="variable">$NPM_PACKAGES</span>/share/man:<span class="subst">$(manpath)</span>&quot;</span></span><br></pre></td></tr></table></figure><ol start="4"><li>更新环境</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure><p>这个时候再去全局安装<code>npm</code>包的话，就不需要root权限，直接将包安装到<code>~/.npm-packages</code>目录下面了。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md">Install npm packages globally without sudo on macOS and Linux</a></p><p><a target="_blank" rel="noopener" href="https://docs.npmjs.com/resolving-eacces-permissions-errors-when-installing-packages-globally">Resolving EACCES permissions errors when installing packages globally</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/07/13/CLIENT-SIDE-CERTIFICATE-AUTHENTICATION-WITH-NGINX/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/07/13/CLIENT-SIDE-CERTIFICATE-AUTHENTICATION-WITH-NGINX/" class="post-title-link" itemprop="url">Nginx双向证书认证</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-07-13 22:07:25" itemprop="dateCreated datePublished" datetime="2018-07-13T22:07:25+08:00">2018-07-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="源起"><a href="#源起" class="headerlink" title="源起"></a>源起</h1><p>服务器已经跑起来很久了，但是有需求要限制客户端使用我们服务，一同事说到了SSL双向认证的问题，之前没有玩过，所以查了一些资料。后来想了下，以前其实也碰到过，就是银行和支付宝的证书认证嘛，通过证书对帐号进行认证。还有一些登录的时候不填帐号，只填密码，其实就是在客户证书来当用户名嘛。这个在Nginx双向认证的时候就可以解决，Nginx收到证书信息，然后反向代理到后面服务的时候，可以在头信息里面加一点东西，就可以解决客户登录的时候的帐号填写问题了。当然还可以又填用户名，又使用证书，然后核对证书的用户名和用户填的用户名是否一致，不致的情况下，可以直接吊销证书等等，可以做的事情就很多了。简单记下之前配置的过程吧。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>可以编辑openssl.cnf，设置一部分默认值，比如国别、组织、机构啊什么的。CentOS在<code>/etc/pki/tls</code>目录下面，Gentoo在<code>/etc/ssl</code>目录下面。因为服务是CentOS，下面默认是在CentOS下操作。如果非root用户操作，做部分修改就行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/pki/CA</span><br><span class="line"><span class="comment"># 好像是证书db</span></span><br><span class="line"><span class="built_in">touch</span> index.txt</span><br><span class="line"><span class="comment"># 证书序号，每生成一个证书自增1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;00&#x27;</span> &gt; serial</span><br></pre></td></tr></table></figure><h2 id="生成CA密钥和证书"><a href="#生成CA密钥和证书" class="headerlink" title="生成CA密钥和证书"></a>生成CA密钥和证书</h2><p>自已充当CA认证机构（一般为第三方权威机构），需要生成一个CA的密钥和证书，用于对其它用户的证书请求进行认证。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -des3 -out ca-key.pem 4096</span><br><span class="line">openssl req -new -x509 -days 3650 -key ca-key.pem -out ca-cert.pem</span><br></pre></td></tr></table></figure><h2 id="生成自签名服务器证书（非必需）"><a href="#生成自签名服务器证书（非必需）" class="headerlink" title="生成自签名服务器证书（非必需）"></a>生成自签名服务器证书（非必需）</h2><p>如果可以，最好去第三方权威机构申请证书（非WoSign），或用letsencrypt的证书。实在不行，就像我们这样，自已生成证书算球的，就可以走下面的流程了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -des3 -out server-key.pem 1024</span><br><span class="line"><span class="comment">#生成无密码的私钥，这样nginx加载的时候不会提示输入密码的地方卡住。或者直接上面那句不加-des3选项</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> server-key.pem -out server-key.key</span><br><span class="line"><span class="comment">#生成csr签名申请，用于CA对证书进行签名。重要：其中提示输入的CN common name必须填服务器的域名、泛域名或IP地址。</span></span><br><span class="line">openssl req -new -key server-key.pem -out server-req.csr</span><br><span class="line"><span class="comment">#用CA对服务器证书进行签名</span></span><br><span class="line">openssl ca -policy policy_anything -days 3650 -CA ca-cert.pem -CAkey ca-key.pem -<span class="keyword">in</span> server-req.csr -out server-cert.pem</span><br></pre></td></tr></table></figure><h2 id="生成客户证书"><a href="#生成客户证书" class="headerlink" title="生成客户证书"></a>生成客户证书</h2><p>与生成服务器证书基本一致，对于CA而言，是一样的。申请过来，进行认证。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -des3 -out client-key.pem 1024</span><br><span class="line"><span class="comment">#生成csr签名申请，用于CA对证书进行签名。</span></span><br><span class="line">openssl req -new -key client-key.pem -out client-req.csr</span><br><span class="line"><span class="comment">#用CA对证书进行签名</span></span><br><span class="line">openssl ca -policy policy_anything -days 3650 -CA ca-cert.pem -CAkey ca-key.pem -<span class="keyword">in</span> client-req.csr -out client-cert.pem</span><br><span class="line"><span class="comment">#客户端证书转换为PKCS #12格式，客户端浏览器导入即可</span></span><br><span class="line"><span class="comment">#openssl pkcs12 -export -out client.pfx -inkey client-key.pem -in client-cert.pem -certfile ca-cert.pem</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -clcerts -<span class="keyword">in</span> client-cert.pem -inkey client-key.pem -out client.p12</span><br></pre></td></tr></table></figure><h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h2><figure class="highlight nginx"><figcaption><span>/etc/nginx/conf.d/default.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span>  test.test;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># 可使用其它机构颁发的证书</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/server-cert.pem;</span><br><span class="line">    <span class="comment"># 服务器私钥</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/server-key.key;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 客户端证书认证</span></span><br><span class="line">    <span class="attribute">ssl_client_certificate</span> /etc/nginx/ssl/ca-cert.pem;</span><br><span class="line">    <span class="comment"># optional表示无证书可访问，用于无证书情况下的提示信息。</span></span><br><span class="line">    <span class="attribute">ssl_verify_client</span> optional;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">5m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1h</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">10M</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 客户端证书认证失败显示400信息</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$ssl_client_verify</span> != <span class="string">&quot;SUCCESS&quot;</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">400</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/goolejuck/article/details/54089170">自签SSL证书实现Nginx配置https双向认证</a></li><li><a target="_blank" rel="noopener" href="http://nategood.com/client-side-certificate-authentication-in-ngi">Client Side Certificate Auth in Nginx</a></li><li><a target="_blank" rel="noopener" href="https://fardog.io/blog/2017/12/30/client-side-certificate-authentication-with-nginx/">CLIENT-SIDE CERTIFICATE AUTHENTICATION WITH NGINX</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/06/09/mybatis-collections-resultmap/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/06/09/mybatis-collections-resultmap/" class="post-title-link" itemprop="url">MyBatis集合映射小试</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-06-09 23:24:47" itemprop="dateCreated datePublished" datetime="2018-06-09T23:24:47+08:00">2018-06-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>现在项目中有个单据有三个表关系，主表、明细表、次明细表，大概关系如下面代码所示。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String mtId;</span><br><span class="line">  <span class="keyword">private</span> List&lt;Sub&gt; subs;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String mtId;</span><br><span class="line">  <span class="keyword">private</span> List&lt;Bat&gt; bats;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bat</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String mtId;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之前有人最笨最笨的办法就是从数据库拉三次出来，然后再组成整个数据结构。其实本来MyBatis里面就有Collection，用起来很方便。然后我就用下面的Mapper.xml来改试了一下。</p><h2 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h2><p><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/sqlmap-xml.html">MyBatis官网</a>已经讲了Collection的使用，很详细了。然后就自己试下看如何更爽的解决之前那个问题。MyBatis已经把配置荐<code>mapUnderscoreToCamelCase</code>设置成<code>true</code>了，这样就可以少写Entity的映射关系了。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getWholeBill&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;EntirBillResultMap&quot;</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">      m.mt_id AS mt_id, s.mt_id AS s_mt_id, b.mt_id AS s_b_mt_it</span><br><span class="line">    FROM</span><br><span class="line">      main m</span><br><span class="line">    INNER JOIN</span><br><span class="line">      sub s ON (s.pid = m.id)</span><br><span class="line">    INNER JOIN</span><br><span class="line">      bat b ON (m.pid = s.id)</span><br><span class="line">    WHERE m.mt_id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;EntirBillResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Main&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;subs&quot;</span> <span class="attr">columnPrefix</span>=<span class="string">&quot;s_&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Sub&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;bats&quot;</span> <span class="attr">columnPrefix</span>=<span class="string">&quot;b_&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Bat&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure><p>本来以为这样可以很好地解决我的问题，但是但是，测试的时候发现，主表和明细表好像没有group by的状态。</p><h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p>碰到这个问题，其实查下源码可能就好解决了。但是其实我一直没有碰MyBatis的源码，所以可能查起来会很头痛。网上稍微搜了下，没有找到答案。应该是映射关系写得有问题吧。尝试了几次，觉得就是没有group by嘛，但是如果告诉MyBatis去group by哪个字段呢？好像平时写得最多的那个id标签没有用哦，太懒了，把这个都省掉。果然加上去就解决了，嗯嗯，很爽。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;EntirBillResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Main&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;mt_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;mtId&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;subs&quot;</span> <span class="attr">columnPrefix</span>=<span class="string">&quot;s_&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Sub&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;mt_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;mtId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;bats&quot;</span> <span class="attr">columnPrefix</span>=<span class="string">&quot;b_&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Bat&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;mt_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;mtId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://notes.guoliangwu.com/2018/06/09/gitlab-runner-configuration/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars.githubusercontent.com/u/1228007?v=4"><meta itemprop="name" content="Liangwu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Liangwu's Notes"><meta itemprop="description" content="Idea, Action"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | Liangwu's Notes"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2018/06/09/gitlab-runner-configuration/" class="post-title-link" itemprop="url">GitLab Runner部分配置</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-06-09 22:44:34" itemprop="dateCreated datePublished" datetime="2018-06-09T22:44:34+08:00">2018-06-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="CI是个好东西"><a href="#CI是个好东西" class="headerlink" title="CI是个好东西"></a>CI是个好东西</h1><p>本身现在所在的团队使用Git的人不多，所以往GitLab上提交代码的时候往往有一些不合格的代码，后来发现GitLab CI可以完美地解决这个问题。</p><h2 id="需求及实现"><a href="#需求及实现" class="headerlink" title="需求及实现"></a>需求及实现</h2><ol><li>service目录中不包含platformService目录。</li><li>所有项目中不能包含.properties文件，以.properties.sample文件提供给大家，然后.gitignore目录中也忽略.properties文件</li><li>config目录中不包含index.js文件，以index.js.sample文件提供给大家</li><li>所有vue代码中不能包含调试用代码”debugger|console.log”</li><li>Java代码能编译通过</li></ol><p>只有通过以上5点的代码才能合并到主仓库，避免污染代码库。其实原因很简单，看下面就清楚。</p><figure class="highlight yaml"><figcaption><span>.gitlab-ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="number">10.17</span><span class="string">.xx.xx/maven:3-jdk-8-alpine</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">MAVEN_OPTS:</span> <span class="string">&quot;-Dmaven.repo.local=/root/.m2/repository -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true&quot;</span></span><br><span class="line">  <span class="attr">MAVEN_CLI_OPTS:</span> <span class="string">&quot;--batch-mode --errors --show-version -Dmaven.test.skip=true -s /root/.m2/settings.xml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:validate:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="string">$(find</span> <span class="string">service</span> <span class="string">-type</span> <span class="string">f</span> <span class="string">-path</span> <span class="string">&quot;*/platformService/*&quot;</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span> <span class="string">-eq</span> <span class="number">0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="string">$(find</span> <span class="string">service</span> <span class="string">-name</span> <span class="string">&quot;*.properties&quot;</span> <span class="string">-path</span> <span class="string">&quot;*/properties/*&quot;</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span> <span class="string">-eq</span> <span class="number">0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="string">$(find</span> <span class="string">web</span> <span class="string">-name</span> <span class="string">&quot;index.js&quot;</span> <span class="string">-path</span> <span class="string">&quot;*/config/*&quot;</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span> <span class="string">-eq</span> <span class="number">0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="string">$(find</span> <span class="string">web</span> <span class="string">-name</span> <span class="string">&quot;*.vue&quot;</span> <span class="string">-type</span> <span class="string">f</span> <span class="string">-exec</span> <span class="string">grep</span> <span class="string">-E</span> <span class="string">&#x27;debugger|console\.log&#x27;</span> &#123;&#125; <span class="string">\;</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span> <span class="string">-eq</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">common</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:compile:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">wget</span> <span class="string">http://10.17.xx.xx/download/settings.xml</span> <span class="string">-O</span> <span class="string">/root/.m2/settings.xml</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">$MAVEN_CLI_OPTS</span> <span class="string">-f</span> <span class="string">service/spdHERPService/pom.xml</span> <span class="string">clean</span> <span class="string">compile</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">common</span></span><br></pre></td></tr></table></figure><h2 id="Docker设置"><a href="#Docker设置" class="headerlink" title="Docker设置"></a>Docker设置</h2><p>其中Runner可能会用到Docker私服，现在我们是用Nexus搭建(IP:10.17.xx.xx)的，Docker需要登录才能使用。下面是Docker的配置，外面配置了两个代理，这样下载外面的镜像速度就很快了。</p><figure class="highlight json"><figcaption><span>daemon.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">,</span> <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.17.xx.xx&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;disable-legacy-registry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5m&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>待Docker配置好后就需要配置Runner了。首先获取Docker登录私服的登录信息，<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#define-an-image-from-a-private-container-registry">官网</a>有两个方法。一个是<br><code>docker login registry.example.com --username my_username --password my_password</code>，然后查看<code>~/.docker/config.json</code>；另外一个是<code>echo -n &quot;my_username:my_password&quot; | base64</code>。然后就是把登录信息加到Runner的配置文件中去。万事OK</p><figure class="highlight toml"><figcaption><span>config.toml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">concurrent</span> = <span class="number">10</span></span><br><span class="line"><span class="attr">check_interval</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  <span class="attr">name</span> = <span class="string">&quot;122-runner&quot;</span></span><br><span class="line">  <span class="attr">url</span> = <span class="string">&quot;http://10.17.xx.xx/gitlab/&quot;</span></span><br><span class="line">  <span class="attr">token</span> = <span class="string">&quot;xxxtoken&quot;</span></span><br><span class="line">  <span class="attr">executor</span> = <span class="string">&quot;docker&quot;</span></span><br><span class="line">  <span class="attr">environment</span> = [<span class="string">&quot;DOCKER_AUTH_CONFIG=&#123; \&quot;auths\&quot;: &#123; \&quot;10.17.xx.xx\&quot;: &#123; \&quot;auth\&quot;: \&quot;authtoken\&quot; &#125; &#125; &#125;&quot;</span>]</span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    <span class="attr">tls_verify</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">image</span> = <span class="string">&quot;alpine:latest&quot;</span></span><br><span class="line">    <span class="attr">privileged</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">disable_cache</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">volumes</span> = [<span class="string">&quot;/cache&quot;</span>, <span class="string">&quot;/root/.m2&quot;</span>]</span><br><span class="line">    <span class="attr">shm_size</span> = <span class="number">0</span></span><br><span class="line">  <span class="section">[runners.cache]</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Liangwu</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a></div></div></footer><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script></body></html>